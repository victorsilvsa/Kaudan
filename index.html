<!doctype html>
<html lang="pt-BR" style="height: 100%;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KauDan - Gestão do Recanto</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&amp;family=Inter:wght@400;500;600&amp;display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body style="height: 100%; width: 100%;"><!-- LOGIN -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo"><i class="fas fa-leaf"></i>
                </div>
                <h1 class="login-title">KauDan</h1>
                <p class="login-subtitle">Gestão do Recanto</p>
            </div>
            <div class="login-error" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group"><label class="form-label" for="loginUser">Usuário</label> <input type="text"
                        class="form-input" id="loginUser" required autofocus>
                </div>
                <div class="form-group"><label class="form-label" for="loginPassword">Senha</label> <input
                        type="password" class="form-input" id="loginPassword" autocomplete="off" placeholder="••••••"
                        required>
                </div><button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            </form>
        </div>
    </div><!-- APP CONTAINER -->
    <div class="app" id="app" style="height: 100%;"><!-- TOP BAR -->
        <div class="top-bar">
            <div class="user-info">
                <div class="user-avatar"><i class="fas fa-user"></i>
                </div>
                <div>
                    <div style="font-size: 0.8rem; color: var(--cinza-500);">
                        Bem-vindo
                    </div>
                    <div id="topBarUser" style="font-size: 1rem; font-weight: 700;">
                        Danilo
                    </div>
                </div>
            </div><button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span
                    style="display: none;">Sair</span></button>
        </div><!-- MAIN WRAPPER -->
        <div class="main-wrapper"><!-- SIDEBAR - Desktop Only -->
            <aside class="sidebar">
                <div class="sidebar-logo"><i class="fas fa-leaf"></i> <span>KauDan</span>
                </div>
                <nav class="sidebar-nav">
                    <div class="nav-item active" data-page="dashboard"><i class="fas fa-chart-line"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-page="calendar"><i class="fas fa-calendar-alt"></i> <span>Agenda</span>
                    </div>
                    <div class="nav-item" data-page="rentals"><i class="fas fa-key"></i> <span>Aluguéis</span>
                    </div>
                    <div class="nav-item" data-page="expenses"><i class="fas fa-receipt"></i> <span>Despesas</span>
                    </div>
                    <div class="nav-item" data-page="clients"><i class="fas fa-users"></i> <span>Clientes</span>
                    </div>
                    <div class="nav-item" data-page="reserves"><i class="fas fa-bookmark"></i> <span>Reservas</span>
                    </div>
                    <div class="nav-item" data-page="notes"><i class="fas fa-sticky-note"></i> <span>Anotações</span>
                    </div>
                    <div class="nav-item" data-page="reports"><i class="fas fa-file-alt"></i> <span>Relatórios</span>
                    </div>
                    <div class="nav-item" data-page="settings"><i class="fas fa-cog"></i> <span>Configurações</span>
                    </div>
                </nav>
                <div class="sidebar-footer"><button class="logout-btn" onclick="logout()"><i
                            class="fas fa-sign-out-alt"></i> Sair</button>
                </div>
            </aside><!-- MAIN CONTENT -->
            <div class="main-content">
                <header class="header">
                    <div class="header-content">
                        <h1 class="header-title" id="pageTitle">Dashboard</h1>
                        <p class="header-subtitle" id="pageSubtitle">Bem-vindo ao Recanto KauDan</p>
                    </div>
                    <div class="header-mobile-brand"><i class="fas fa-leaf"></i> <span>KauDan</span>
                    </div>
                </header>
                <div class="content" id="content"></div>
            </div>
        </div><!-- BOTTOM BAR - Mobile Only -->
        <div class="bottom-bar">
            <div class="bottom-nav-item active" data-page="dashboard"><i class="fas fa-chart-line"></i>
                <span>Dashboard</span>
            </div>
            <div class="bottom-nav-item" data-page="calendar"><i class="fas fa-calendar-alt"></i> <span>Agenda</span>
            </div>
            <div class="bottom-nav-item" data-page="rentals"><i class="fas fa-key"></i> <span>Aluguéis</span>
            </div>
            <div class="bottom-nav-item" data-page="expenses"><i class="fas fa-receipt"></i> <span>Despesas</span>
            </div>
            <div class="bottom-nav-item bottom-nav-more" onclick="toggleBottomMenu()"><i class="fas fa-ellipsis-h"></i>
                <span>Mais</span>
            </div>
        </div><!-- BOTTOM MENU - More Options -->
        <div class="bottom-menu" id="bottomMenu">
            <div class="bottom-menu-header">
                Mais Opções
            </div>
            <div class="bottom-menu-item" data-page="clients" onclick="navigatePage('clients'); toggleBottomMenu();"><i
                    class="fas fa-users"></i> <span>Clientes</span>
            </div>
            <div class="bottom-menu-item" data-page="reserves" onclick="navigatePage('reserves'); toggleBottomMenu();">
                <i class="fas fa-bookmark"></i> <span>Reservas</span>
            </div>
            <div class="bottom-menu-item" data-page="notes" onclick="navigatePage('notes'); toggleBottomMenu();"><i
                    class="fas fa-sticky-note"></i> <span>Anotações</span>
            </div>
            <div class="bottom-menu-item" data-page="reports" onclick="navigatePage('reports'); toggleBottomMenu();"><i
                    class="fas fa-file-alt"></i> <span>Relatórios</span>
            </div>
            <div class="bottom-menu-item" data-page="settings" onclick="navigatePage('settings'); toggleBottomMenu();">
                <i class="fas fa-cog"></i> <span>Configurações</span>
            </div>
            <div style="border-top: 2px solid var(--verde-claro); margin: 0.5rem 0; padding: 0.5rem 0;"></div>
            <div class="bottom-menu-item" onclick="logout();" style="color: #ef4444;"><i class="fas fa-sign-out-alt"
                    style="color: #ef4444;"></i> <span>Sair</span>
            </div>
        </div>
    </div><!-- MODAL BACKDROP -->
    <div class="modal-backdrop" id="modalBackdrop"></div><!-- RENTAL MODAL -->
    <div class="modal" id="rentalModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('rentalModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-plus"></i> Nova Locação
            </div>
            <form id="rentalForm">
                <div class="form-group"><label class="form-label" for="clientName">Nome do Cliente</label> <input
                        type="text" class="form-input" id="clientName" required>
                </div>
                <div class="form-group"><label class="form-label" for="periodSelected">Período Selecionado</label>
                    <input type="text" class="form-input" id="periodSelected" readonly
                        style="background: var(--cinza-100);">
                </div>
                <div class="form-group"><label class="form-label" for="daysCount">Quantidade de Dias</label> <input
                        type="number" class="form-input" id="daysCount" readonly style="background: var(--cinza-100);">
                </div>
                <div class="form-group"><label class="form-label" for="dailyRate">Valor da Diária (R$)</label> <input
                        type="number" class="form-input" id="dailyRate" min="0" step="0.01" required
                        onchange="calcRentalTotal()">
                </div>
                <div class="form-group"><label class="form-label" for="rentalTotal">Total (R$)</label> <input
                        type="text" class="form-input" id="rentalTotal" readonly
                        style="background: var(--cinza-100); font-weight: 700; color: var(--verde-principal); font-size: 1.25rem;">
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Confirmar</button> <button
                        type="button" class="btn btn-secondary" onclick="closeModal('rentalModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div><!-- QUICK ADD EXPENSE MODAL -->
    <div class="modal" id="quickAddModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('quickAddModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-plus"></i> <span id="quickAddTitle">Lançar Despesa</span>
            </div>
            <form id="quickAddForm">
                <div class="form-group"><label class="form-label" for="quickAmount">Valor (R$)</label> <input
                        type="number" class="form-input" id="quickAmount" placeholder="0,00" min="0" step="0.01"
                        required autofocus>
                </div>
                <div class="form-group"><label class="form-label" for="quickDate">Data</label> <input type="date"
                        class="form-input" id="quickDate" required>
                </div>
                <div class="form-group"><label class="form-label" for="quickNote">Observação (opcional)</label> <input
                        type="text" class="form-input" id="quickNote" placeholder="Ex: Reparação...">
                </div><button type="submit" class="btn btn-primary btn-block"><i class="fas fa-check"></i>
                    Confirmar</button>
            </form>
        </div>
    </div><!-- EDIT EXPENSE MODAL -->
    <div class="modal" id="editExpenseModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('editExpenseModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-edit"></i> Editar Despesa
            </div>
            <form id="editExpenseForm">
                <div class="form-group"><label class="form-label" for="editAmount">Valor (R$)</label> <input
                        type="number" class="form-input" id="editAmount" min="0" step="0.01" required>
                </div>
                <div class="form-group"><label class="form-label" for="editDate">Data</label> <input type="date"
                        class="form-input" id="editDate" required>
                </div>
                <div class="form-group"><label class="form-label" for="editNote">Observação</label> <input type="text"
                        class="form-input" id="editNote">
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Salvar</button> <button
                        type="button" class="btn btn-secondary"
                        onclick="closeModal('editExpenseModal')">Cancelar</button> <button type="button"
                        class="btn btn-danger" onclick="deleteCurrentExpense()">Excluir</button>
                </div>
            </form>
        </div>
    </div><!-- HISTORY MODAL -->
    <div class="modal" id="historyModal">
        <div class="modal-content" style="max-width: 100%; max-height: 80vh;"><button class="modal-close"
                onclick="closeModal('historyModal')"><i class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-history"></i> <span id="historyTitle">Histórico</span>
            </div>
            <div id="historyList" style="overflow-y: auto;"></div>
        </div>
    </div><!-- CLIENT MODAL -->
    <div class="modal" id="clientModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('clientModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-user-plus"></i> Novo Cliente
            </div>
            <form id="clientForm">
                <div class="form-group"><label class="form-label" for="clientFullName">Nome Completo</label> <input
                        type="text" class="form-input" id="clientFullName" required autofocus>
                </div>
                <div class="form-group"><label class="form-label" for="clientEmail">Email</label> <input type="email"
                        class="form-input" id="clientEmail">
                </div>
                <div class="form-group"><label class="form-label" for="clientCPF">CPF</label> <input type="text"
                        class="form-input" id="clientCPF" placeholder="000.000.000-00">
                </div>
                <div class="form-group"><label class="form-label" for="clientPhone">Telefone</label> <input type="tel"
                        class="form-input" id="clientPhone">
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Salvar</button> <button
                        type="button" class="btn btn-secondary" onclick="closeModal('clientModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div><!-- EDIT CLIENT MODAL -->
    <div class="modal" id="editClientModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('editClientModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-edit"></i> Editar Cliente
            </div>
            <form id="editClientForm">
                <div class="form-group"><label class="form-label" for="editClientName">Nome Completo</label> <input
                        type="text" class="form-input" id="editClientName" required>
                </div>
                <div class="form-group"><label class="form-label" for="editClientEmail">Email</label> <input
                        type="email" class="form-input" id="editClientEmail">
                </div>
                <div class="form-group"><label class="form-label" for="editClientCPF">CPF</label> <input type="text"
                        class="form-input" id="editClientCPF" placeholder="000.000.000-00">
                </div>
                <div class="form-group"><label class="form-label" for="editClientPhone">Telefone</label> <input
                        type="tel" class="form-input" id="editClientPhone">
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Salvar</button> <button
                        type="button" class="btn btn-secondary"
                        onclick="closeModal('editClientModal')">Cancelar</button> <button type="button"
                        class="btn btn-danger" onclick="deleteCurrentClient()">Excluir</button>
                </div>
            </form>
        </div>
    </div><!-- RESERVE MODAL -->
    <div class="modal" id="reserveModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('reserveModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-bookmark"></i> Nova Reserva
            </div>
            <form id="reserveForm">
                <div class="form-group"><label class="form-label" for="reserveClient">Cliente</label> <select
                        class="form-select" id="reserveClient" required>
                        <option value="">Selecione um cliente...</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label" for="reservePeriod">Período Selecionado</label> <input
                        type="text" class="form-input" id="reservePeriod" readonly
                        style="background: var(--cinza-100);">
                </div>
                <div class="form-group"><label class="form-label" for="reserveRate">Valor da Diária (R$)</label> <input
                        type="number" class="form-input" id="reserveRate" min="0" step="0.01" required>
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Confirmar Reserva</button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('reserveModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div><!-- EDIT RENTAL MODAL -->
    <div class="modal" id="editRentalModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('editRentalModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-edit"></i> Editar Locação
            </div>
            <form id="editRentalForm">
                <div class="form-group"><label class="form-label" for="editRentalClientName">Nome do Cliente</label>
                    <input type="text" class="form-input" id="editRentalClientName" required>
                </div>
                <div class="form-group"><label class="form-label" for="editRentalStartDate">Data Início</label> <input
                        type="date" class="form-input" id="editRentalStartDate" required>
                </div>
                <div class="form-group"><label class="form-label" for="editRentalEndDate">Data Fim</label> <input
                        type="date" class="form-input" id="editRentalEndDate" required>
                </div>
                <div class="form-group"><label class="form-label" for="editRentalDailyRate">Valor da Diária (R$)</label>
                    <input type="number" class="form-input" id="editRentalDailyRate" min="0" step="0.01" required
                        onchange="calcEditRentalTotal()">
                </div>
                <div class="form-group"><label class="form-label" for="editRentalTotal">Total (R$)</label> <input
                        type="text" class="form-input" id="editRentalTotal" readonly
                        style="background: var(--cinza-100); font-weight: 700; color: var(--verde-principal); font-size: 1.25rem;">
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Salvar</button> <button
                        type="button" class="btn btn-secondary"
                        onclick="closeModal('editRentalModal')">Cancelar</button> <button type="button"
                        class="btn btn-danger" onclick="deleteCurrentRental()">Excluir</button>
                </div>
            </form>
        </div>
    </div><!-- EDIT RESERVE MODAL -->
    <div class="modal" id="editReserveModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('editReserveModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-edit"></i> Editar Reserva
            </div>
            <form id="editReserveForm">
                <div class="form-group"><label class="form-label" for="editReserveClientName">Cliente</label> <input
                        type="text" class="form-input" id="editReserveClientName" readonly
                        style="background: var(--cinza-100);">
                </div>
                <div class="form-group"><label class="form-label" for="editReserveStartDate">Data Início</label> <input
                        type="date" class="form-input" id="editReserveStartDate" required>
                </div>
                <div class="form-group"><label class="form-label" for="editReserveEndDate">Data Fim</label> <input
                        type="date" class="form-input" id="editReserveEndDate" required>
                </div>
                <div class="form-group"><label class="form-label" for="editReserveDailyRate">Valor da Diária
                        (R$)</label> <input type="number" class="form-input" id="editReserveDailyRate" min="0"
                        step="0.01" required onchange="calcEditReserveTotal()">
                </div>
                <div class="form-group"><label class="form-label" for="editReserveTotal">Estimado (R$)</label> <input
                        type="text" class="form-input" id="editReserveTotal" readonly
                        style="background: var(--cinza-100); font-weight: 700; color: var(--verde-principal); font-size: 1.25rem;">
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Salvar</button> <button
                        type="button" class="btn btn-secondary"
                        onclick="closeModal('editReserveModal')">Cancelar</button> <button type="button"
                        class="btn btn-danger" onclick="deleteCurrentReserve()">Excluir</button>
                </div>
            </form>
        </div>
    </div><!-- ADD NOTE MODAL -->
    <div class="modal" id="addNoteModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('addNoteModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-sticky-note"></i> Nova Anotação
            </div>
            <form id="addNoteForm">
                <div class="form-group"><label class="form-label" for="noteTitle">Título</label> <input type="text"
                        class="form-input" id="noteTitle" required autofocus>
                </div>
                <div class="form-group"><label class="form-label" for="noteContent">Conteúdo</label> <textarea
                        class="form-input" id="noteContent" placeholder="Digite sua anotação aqui..."
                        style="min-height: 120px; resize: vertical;" required></textarea>
                </div>
                <div class="modal-buttons"><button type="submit" class="btn btn-primary">Salvar</button> <button
                        type="button" class="btn btn-secondary" onclick="closeModal('addNoteModal')">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 id="confirmTitle" style="margin-bottom: 1rem; color: var(--verde-principal);"></h3>
            <p id="confirmMessage" style="margin-bottom: 1.5rem; color: var(--cinza-700); line-height: 1.5;"></p>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;"><button type="button"
                    class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancelar</button> <button
                    type="button" class="btn btn-danger" id="confirmButton">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="modalBackdrop" class="modal-backdrop"></div>

    <div id="modal" class="modal">
        <div class="modal-content" id="modalContent">
            <!-- conteúdo injetado via JS -->
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settingsModal">
        <div class="modal-content"><button class="modal-close" onclick="closeModal('settingsModal')"><i
                    class="fas fa-times"></i></button>
            <div class="modal-header"><i class="fas fa-cog"></i> Configurações
            </div>
            <form id="settingsForm">
                <div class="form-group"><label class="form-label" for="initialCapital">Capital Inicial (R$)</label>
                    <input type="number" class="form-input" id="initialCapital" min="0" step="0.01" required>
                </div>
                <div class="form-group"><label class="form-label" for="defaultDailyRate">Diária Padrão (R$)</label>
                    <input type="number" class="form-input" id="defaultDailyRate" min="0" step="0.01" required>
                </div>
                <div class="form-group"
                    style="margin-top: 2rem; border-top: 2px solid var(--cinza-200); padding-top: 1.5rem;"><label
                        class="form-label" style="color: #ef4444; font-weight: 700;">Zona de Perigo</label> <button
                        type="button" class="btn btn-danger btn-block" onclick="resetAllData()"><i
                            class="fas fa-trash"></i> Resetar Todos os Dados</button>
                </div>
                <div class="modal-buttons" style="margin-top: 2rem;"><button type="submit"
                        class="btn btn-primary">Salvar</button> <button type="button" class="btn btn-secondary"
                        onclick="closeModal('settingsModal')">Fechar</button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCrZhLisPAGQerW4Ziuk3wyEE3I23gFyyQ",
            authDomain: "kaudan-5d2d3.firebaseapp.com",
            databaseURL: "https://kaudan-5d2d3-default-rtdb.firebaseio.com",
            projectId: "kaudan-5d2d3",
            storageBucket: "kaudan-5d2d3.firebasestorage.app",
            messagingSenderId: "263883565895",
            appId: "1:263883565895:web:354ccf8d8216e4e5e9ba62",
            measurementId: "G-EE71PP5DS9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Realtime Database
        const db = firebase.database();


        // ===== GLOBAL STATE =====
        let currentUser = null;
        let currentUserId = null;
        let currentPage = 'dashboard';
        let selectedDays = [];
        let rentals = [];
        let expenses = [];
        let reserves = [];
        let clients = [];
        let notes = [];
        let currentEditingExpenseId = null;
        let currentEditingRentalId = null;
        let currentEditingClientId = null;
        let currentEditingReserveId = null;
        let currentEditingCategory = null;
        let currentMonthYear = new Date();
        let pdfType = 'geral';

        let settings = {
            initialCapital: 5000,
            defaultDailyRate: 200
        };


        const categories = {
            internet: { name: 'Internet', icon: 'fas fa-wifi' },
            piscineiro: { name: 'Piscineiro', icon: 'fas fa-swimmer' },
            faxineira: { name: 'Faxineira', icon: 'fas fa-broom' },
            servico: { name: 'Serviço Geral', icon: 'fas fa-wrench' },
            condominio: { name: 'Condomínio', icon: 'fas fa-building' },
            agua: { name: 'Água', icon: 'fas fa-droplet' },
            luz: { name: 'Luz', icon: 'fas fa-lightbulb' },
            fatura: { name: 'Fatura', icon: 'fas fa-file-invoice' },
            outros: { name: 'Outros', icon: 'fas fa-box' }
        };




        // ===== UTILITIES =====
        function formatCurrency(value) {
            if (!value || isNaN(value)) return 'R$ 0,00';

            const num = parseFloat(value);

            if (num >= 1000000) {
                return 'R$ ' + (num / 1000000).toFixed(2).replace('.', ',') + 'M';
            } else if (num >= 1000) {
                return 'R$ ' + (num / 1000).toFixed(2).replace('.', ',') + 'K';
            }

            return 'R$ ' + num.toFixed(2).replace('.', ',');
        }

        // Exemplos de uso:
        // formatCurrency(1500) → "R$ 1,50K"
        // formatCurrency(50000) → "R$ 50,00K"
        // formatCurrency(1500000) → "R$ 1,50M"
        // formatCurrency(750) → "R$ 750,00"


        function formatCurrency(value, options = {}) {
            if (!value || isNaN(value)) return 'R$ 0,00';

            const num = parseFloat(value);
            const useAbreviation = options.useAbreviation !== false; // true por padrão
            const decimals = options.decimals !== undefined ? options.decimals : 2;

            if (!useAbreviation) {
                return 'R$ ' + num.toFixed(decimals).replace('.', ',');
            }

            if (num >= 1000000) {
                return 'R$ ' + (num / 1000000).toFixed(decimals).replace('.', ',') + 'M';
            } else if (num >= 1000) {
                return 'R$ ' + (num / 1000).toFixed(decimals).replace('.', ',') + 'K';
            }

            return 'R$ ' + num.toFixed(decimals).replace('.', ',');
        }



        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return new Intl.DateTimeFormat('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).format(date);
        }

        // ===== AUTHENTICATION =====
        function initAuth() {
            const savedUserId = localStorage.getItem("currentUserId");

            if (savedUserId) {
                currentUserId = savedUserId;

                db.ref("users/" + currentUserId).once("value", (snapshot) => {
                    if (snapshot.exists()) {
                        currentUser = snapshot.val();
                        document.getElementById('topBarUser').textContent = currentUser.username;
                        showApp();
                        loadData();
                        syncDataFromFirebase();
                    } else {
                        currentUserId = null;
                        currentUser = null;
                        localStorage.removeItem("currentUserId");
                        showLogin();
                    }
                });
            } else {
                currentUserId = null;
                currentUser = null;
                showLogin();
            }
        }


        function showLogin() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('app').classList.remove('show');
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function showApp() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('app').classList.add('show');
            init();
        }

        function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            // Login fixo
            if (email === "danilo" && pass === "123") {
                currentUserId = "defaultUser";
                currentUser = { username: "danilo", uid: currentUserId };

                localStorage.setItem("currentUserId", currentUserId);

                document.getElementById('loginForm').reset();
                errorEl.classList.remove('show');
                document.getElementById('topBarUser').textContent = currentUser.username;

                showToast('Login realizado com sucesso!', 'success', 2000);
                showApp();
                loadData();
                syncDataFromFirebase();
            } else {
                errorEl.textContent = 'Usuário ou senha incorretos!';
                errorEl.classList.add('show');
                showToast('Usuário ou senha incorretos!', 'error', 3000);
            }
        }


        // ===== FIREBASE DATA FUNCTIONS =====
        function loadSettings() {
            if (!currentUserId) return;
            db.ref(`users/${currentUserId}/settings`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    settings = { ...settings, ...snapshot.val() };
                } else {
                    saveSettings();
                }
            });
        }

        function saveSettings() {
            if (!currentUserId) return;
            db.ref(`users/${currentUserId}/settings`).set(settings)
                .catch((error) => {
                    showToast('Erro ao salvar configurações: ' + error.message, 'error');
                });
        }

        function loadData() {
            if (!currentUserId) return;

            db.ref(`users/${currentUserId}/rentals`).once('value', (snapshot) => {
                rentals = snapshot.val() ? Object.values(snapshot.val()) : [];
            });

            db.ref(`users/${currentUserId}/expenses`).once('value', (snapshot) => {
                expenses = snapshot.val() ? Object.values(snapshot.val()) : [];
            });

            db.ref(`users/${currentUserId}/reserves`).once('value', (snapshot) => {
                reserves = snapshot.val() ? Object.values(snapshot.val()) : [];
            });

            db.ref(`users/${currentUserId}/clients`).once('value', (snapshot) => {
                clients = snapshot.val() ? Object.values(snapshot.val()) : [];
            });

            db.ref(`users/${currentUserId}/notes`).once('value', (snapshot) => {
                notes = snapshot.val() ? Object.values(snapshot.val()) : [];
            });

            loadSettings();
        }

        function saveData() {
            if (!currentUserId) return;
            saveToFirebase('rentals', rentals);
            saveToFirebase('expenses', expenses);
            saveToFirebase('reserves', reserves);
            saveToFirebase('clients', clients);
            saveToFirebase('notes', notes);
        }

        function syncDataFromFirebase() {
            if (!currentUserId) return;

            db.ref(`users/${currentUserId}/rentals`).on('value', (snapshot) => {
                rentals = snapshot.val() ? Object.values(snapshot.val()) : [];
                if (currentPage === 'dashboard' || currentPage === 'calendar' || currentPage === 'rentals') {
                    renderPage();
                }
            });

            db.ref(`users/${currentUserId}/expenses`).on('value', (snapshot) => {
                expenses = snapshot.val() ? Object.values(snapshot.val()) : [];
                if (currentPage === 'dashboard' || currentPage === 'expenses') {
                    renderPage();
                }
            });

            db.ref(`users/${currentUserId}/reserves`).on('value', (snapshot) => {
                reserves = snapshot.val() ? Object.values(snapshot.val()) : [];
                if (currentPage === 'dashboard' || currentPage === 'reserves') {
                    renderPage();
                }
            });

            db.ref(`users/${currentUserId}/clients`).on('value', (snapshot) => {
                clients = snapshot.val() ? Object.values(snapshot.val()) : [];
                if (currentPage === 'clients') {
                    renderPage();
                }
            });

            db.ref(`users/${currentUserId}/notes`).on('value', (snapshot) => {
                notes = snapshot.val() ? Object.values(snapshot.val()) : [];
                if (currentPage === 'notes') {
                    renderPage();
                }
            });
        }

        function saveToFirebase(dataType, data) {
            if (!currentUserId) return;
            const firebaseData = {};
            data.forEach((item, index) => {
                firebaseData[item.id || index] = item;
            });
            db.ref(`users/${currentUserId}/${dataType}`).set(firebaseData)
                .catch((error) => {
                    showToast('Erro ao salvar ' + dataType + ': ' + error.message, 'error');
                });
        }

        function updateToFirebase(dataType, id, data) {
            if (!currentUserId) return;
            db.ref(`users/${currentUserId}/${dataType}/${id}`).update(data)
                .catch((error) => {
                    showToast('Erro ao atualizar: ' + error.message, 'error');
                });
        }

        function deleteFromFirebase(dataType, id) {
            if (!currentUserId) return;
            db.ref(`users/${currentUserId}/${dataType}/${id}`).remove()
                .catch((error) => {
                    showToast('Erro ao deletar: ' + error.message, 'error');
                });
        }

        // Sistema de notificações Toast
        const toastContainer = document.getElementById('toast-container') || createToastContainer();

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    `;
            document.body.appendChild(container);
            return container;
        }

        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };

            toast.style.cssText = `
        background-color: ${colors[type] || colors.info};
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-size: 14px;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
        min-width: 300px;
    `;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Adicionar animações CSS
        if (!document.getElementById('toast-styles')) {
            const style = document.createElement('style');
            style.id = 'toast-styles';
            style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    `;
            document.head.appendChild(style);
        }

        // Modal de confirmação
        function showConfirmModal(title, message, onConfirm, onCancel) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease-out;
    `;

            const modal = document.createElement('div');
            modal.style.cssText = `
        background-color: white;
        border-radius: 12px;
        padding: 24px;
        max-width: 400px;
        box-shadow: 0 20px 25px rgba(0,0,0,0.15);
        animation: slideUp 0.3s ease-out;
    `;

            modal.innerHTML = `
        <h2 style="margin: 0 0 12px 0; font-size: 18px; color: #1f2937;">${title}</h2>
        <p style="margin: 0 0 24px 0; font-size: 14px; color: #6b7280;">${message}</p>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button id="cancel-btn" style="
                background-color: #e5e7eb;
                color: #374151;
                border: none;
                padding: 10px 16px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: background-color 0.2s;
            ">Cancelar</button>
            <button id="confirm-btn" style="
                background-color: #ef4444;
                color: white;
                border: none;
                padding: 10px 16px;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: background-color 0.2s;
            ">Confirmar</button>
        </div>
    `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            const confirmBtn = modal.querySelector('#confirm-btn');
            const cancelBtn = modal.querySelector('#cancel-btn');

            confirmBtn.onmouseover = () => confirmBtn.style.backgroundColor = '#dc2626';
            confirmBtn.onmouseout = () => confirmBtn.style.backgroundColor = '#ef4444';

            cancelBtn.onmouseover = () => cancelBtn.style.backgroundColor = '#d1d5db';
            cancelBtn.onmouseout = () => cancelBtn.style.backgroundColor = '#e5e7eb';

            confirmBtn.addEventListener('click', () => {
                overlay.remove();
                onConfirm();
            });

            cancelBtn.addEventListener('click', () => {
                overlay.remove();
                onCancel && onCancel();
            });
        }

        // Adicionar animações para modal
        if (!document.getElementById('modal-styles')) {
            const style = document.createElement('style');
            style.id = 'modal-styles';
            style.textContent = `
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    `;
            document.head.appendChild(style);
        }

        // Função logout modificada
        function logout() {
            showConfirmModal(
                'Sair do Sistema',
                'Deseja realmente sair do sistema?',
                () => {
                    auth.signOut()
                        .then(() => {
                            currentUser = null;
                            currentUserId = null;
                            showToast('Você saiu do sistema com sucesso!', 'success', 2000);
                            setTimeout(() => {
                                showLogin();
                            }, 500);
                        })
                        .catch((error) => {
                            showToast('Erro ao sair: ' + error.message, 'error');
                        });
                },
                () => {
                    showToast('Saída cancelada', 'info', 1500);
                }
            );
        }


        // ===== INIT =====
        function init() {
            loadSettings();
            loadData();
            setupNavigation();
            setupFormHandlers();
            setupModalBackdrop();
            renderPage();
        }

        // ===== MODAL MANAGEMENT =====
        function setupModalBackdrop() {
            const backdrop = document.getElementById('modalBackdrop');
            backdrop.addEventListener('click', () => {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
                backdrop.classList.remove('show');
            });
        }

        function openModal(id) {
            const modal = document.getElementById(id);
            const backdrop = document.getElementById('modalBackdrop');

            modal.classList.add('show');
            backdrop.classList.add('show');

            if (id === 'rentalModal') {
                document.getElementById('dailyRate').value = settings.defaultDailyRate;
                calcRentalTotal();
            } else if (id === 'settingsModal') {
                document.getElementById('initialCapital').value = settings.initialCapital;
                document.getElementById('defaultDailyRate').value = settings.defaultDailyRate;
            } else if (id === 'reserveModal') {
                populateClientSelect();
            }
        }

        function closeModal(id = 'modal') {
            const modal = document.getElementById(id);
            const backdrop = document.getElementById('modalBackdrop');
            const modalContent = document.getElementById('modalContent');

            if (modal) {
                modal.classList.remove('show');
            }

            // Verifica se ainda existe algum modal aberto
            const anyOpen = document.querySelectorAll('.modal.show').length > 0;

            if (!anyOpen && backdrop) {
                backdrop.classList.remove('show');
            }

            // Limpa conteúdo apenas do modal principal
            if (modalContent && id === 'modal') {
                modalContent.innerHTML = '';
            }
        }

        // ===== DATA MANAGEMENT =====
        function loadSettings() {
            const saved = localStorage.getItem('rentalflow_settings');
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
        }

        function saveSettings() {
            localStorage.setItem('rentalflow_settings', JSON.stringify(settings));
        }

        function loadData() {
            const savedRentals = localStorage.getItem('rentalflow_rentals');
            rentals = savedRentals ? Object.values(JSON.parse(savedRentals)) : [];

            const savedExpenses = localStorage.getItem('rentalflow_expenses');
            expenses = savedExpenses ? Object.values(JSON.parse(savedExpenses)) : [];

            const savedReserves = localStorage.getItem('rentalflow_reserves');
            reserves = savedReserves ? Object.values(JSON.parse(savedReserves)) : [];

            const savedClients = localStorage.getItem('rentalflow_clients');
            clients = savedClients ? Object.values(JSON.parse(savedClients)) : [];

            const savedNotes = localStorage.getItem('rentalflow_notes');
            notes = savedNotes ? Object.values(JSON.parse(savedNotes)) : [];
        }

        function saveData() {
            saveToFirebase('rentals', rentals);
            saveToFirebase('expenses', expenses);
            saveToFirebase('reserves', reserves);
            saveToFirebase('clients', clients);
            saveToFirebase('notes', notes);
        }

        function saveToFirebase(dataType, data) {
            if (!data || !Array.isArray(data)) {
                data = [];
            }

            const firebaseData = {};
            data.forEach((item, index) => {
                firebaseData[item.id || index] = item;
            });

            localStorage.setItem('rentalflow_' + dataType, JSON.stringify(firebaseData));
        }

        function updateToFirebase(dataType, id, dataUpdate) {
            const key = 'rentalflow_' + dataType;
            const saved = localStorage.getItem(key);
            const firebaseData = saved ? JSON.parse(saved) : {};

            firebaseData[id] = { ...firebaseData[id], ...dataUpdate };
            localStorage.setItem(key, JSON.stringify(firebaseData));
        }

        function deleteFromFirebase(dataType, id) {
            const key = 'rentalflow_' + dataType;
            const saved = localStorage.getItem(key);
            const firebaseData = saved ? JSON.parse(saved) : {};

            delete firebaseData[id];
            localStorage.setItem(key, JSON.stringify(firebaseData));
        }

        // ===== NAVIGATION =====
        function navigatePage(page) {
            // Update desktop sidebar
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update mobile bottom bar
            document.querySelectorAll('.bottom-nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.bottom-nav-item[data-page="${page}"]`)?.classList.add('active');

            // Update bottom menu items
            document.querySelectorAll('.bottom-menu-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.bottom-menu-item[data-page="${page}"]`)?.classList.add('active');

            currentPage = page;
            selectedDays = [];
            renderPage();
        }

        function toggleBottomMenu() {
            document.getElementById('bottomMenu').classList.toggle('show');
        }

        function setupNavigation() {
            // Desktop sidebar
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    navigatePage(item.dataset.page);
                });
            });

            // Mobile bottom bar
            document.querySelectorAll('.bottom-nav-item:not(.bottom-nav-more)').forEach(item => {
                item.addEventListener('click', () => {
                    navigatePage(item.dataset.page);
                });
            });

            // Bottom menu items - fecha o menu após clicar
            document.querySelectorAll('.bottom-menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    navigatePage(item.dataset.page);
                    // Fecha o menu após a navegação
                    document.getElementById('bottomMenu').classList.remove('show');
                });
            });
        }

        function renderPage() {
            const content = document.getElementById('content');
            const headerTitle = document.getElementById('pageTitle');
            const headerSubtitle = document.getElementById('pageSubtitle');

            const pages = {
                dashboard: {
                    title: 'Dashboard',
                    subtitle: 'Visão geral do seu negócio',
                    render: renderDashboard
                },
                calendar: {
                    title: 'Agenda',
                    subtitle: 'Calendário de locações e reservas',
                    render: renderCalendar
                },
                rentals: {
                    title: 'Aluguéis',
                    subtitle: 'Gerenciar locações confirmadas',
                    render: renderRentals
                },
                expenses: {
                    title: 'Despesas',
                    subtitle: 'Lançar e gerenciar gastos',
                    render: renderExpenses
                },
                clients: {
                    title: 'Clientes',
                    subtitle: 'Gestão de clientes',
                    render: renderClients
                },
                reserves: {
                    title: 'Reservas',
                    subtitle: 'Gerenciar reservas em andamento',
                    render: renderReserves
                },
                notes: {
                    title: 'Anotações',
                    subtitle: 'Suas anotações e lembretes',
                    render: renderNotes
                },
                reports: {
                    title: 'Relatórios',
                    subtitle: 'Exportar dados em PDF',
                    render: renderReports
                },
                settings: {
                    title: 'Configurações',
                    subtitle: 'Ajustes do sistema',
                    render: () => { openModal('settingsModal'); return ''; }
                }
            };

            const page = pages[currentPage];
            headerTitle.textContent = page.title;
            headerSubtitle.textContent = page.subtitle;
            content.innerHTML = page.render();
        }


        // ===== CORE DATA MANAGEMENT =====
        let syncListeners = [];

        function addSyncListener(callback) {
            syncListeners.push(callback);
        }

        function triggerSync(type, data) {
            syncListeners.forEach(cb => cb(type, data));
            saveAllData();
        }

        function saveAllData() {
            saveToFirebase('rentals', rentals);
            saveToFirebase('reserves', reserves);
            saveToFirebase('expenses', expenses);
            saveToFirebase('clients', clients);
            saveSettings();
        }

        // ===== DASHBOARD =====
        function calculateCapital() {
            const totalRental = rentals.reduce((sum, r) => sum + r.total, 0);
            const totalReserve = reserves.reduce((sum, r) => sum + (r.dailyRate * r.days), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
            return settings.initialCapital + totalRental - totalExpenses;
        }

        function calculateMonthlyRevenue() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return rentals
                .filter(r => r.startDate.startsWith(currentMonth) || r.endDate.startsWith(currentMonth))
                .reduce((sum, r) => sum + r.total, 0);
        }

        function calculateMonthlyExpenses() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return expenses
                .filter(e => e.date.startsWith(currentMonth))
                .reduce((sum, e) => sum + e.amount, 0);
        }

        function calculateRentedDays() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return rentals
                .filter(r => r.startDate.startsWith(currentMonth) || r.endDate.startsWith(currentMonth))
                .reduce((sum, r) => sum + r.days, 0);
        }

        function getNextRental() {
            const now = new Date();
            const upcomingRentals = rentals
                .filter(r => new Date(r.startDate) >= now)
                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            return upcomingRentals[0] || null;
        }

        function formatCurrencyCompact(value) {
            if (value >= 1000000000) {
                return 'R$ ' + (value / 1000000000).toFixed(1).replace('.0', '') + 'B';
            }
            if (value >= 1000000) {
                return 'R$ ' + (value / 1000000).toFixed(1).replace('.0', '') + 'M';
            }
            if (value >= 1000) {
                return 'R$ ' + (value / 1000).toFixed(1).replace('.0', '') + 'K';
            }
            return formatCurrency(value);
        }

        function renderDashboard() {
            const capital = calculateCapital();
            const monthlyRevenue = calculateMonthlyRevenue();
            const monthlyExpenses = calculateMonthlyExpenses();
            const rentedDaysCount = calculateRentedDays();
            const nextRental = getNextRental();

            const html = `
        <div class="stats-grid">
            <div class="stat-box stat-box-clickable" data-stat="capital" style="cursor: pointer;" title="${formatCurrency(capital)}">
                <div class="stat-label"><i class="fas fa-wallet"></i> Capital Atual</div>
                <div class="stat-value" style="word-break: break-word; overflow-wrap: break-word;">${formatCurrencyCompact(capital)}</div>
                <div class="stat-change" style="word-break: break-word; overflow-wrap: break-word;" title="${formatCurrency(capital - settings.initialCapital)}">${capital >= settings.initialCapital ? '+' : ''}${formatCurrencyCompact(capital - settings.initialCapital)}</div>
            </div>
            <div class="stat-box stat-box-clickable" data-stat="revenue" style="cursor: pointer;" title="${formatCurrency(monthlyRevenue)}">
                <div class="stat-label"><i class="fas fa-arrow-trend-up"></i> Receita (Mês)</div>
                <div class="stat-value" style="word-break: break-word; overflow-wrap: break-word;">${formatCurrencyCompact(monthlyRevenue)}</div>
                <div class="stat-change">${rentals.filter(r => r.startDate.startsWith(new Date().toISOString().slice(0, 7))).length} locações</div>
            </div>
            <div class="stat-box stat-box-clickable" data-stat="expenses" style="cursor: pointer;" title="${formatCurrency(monthlyExpenses)}">
                <div class="stat-label"><i class="fas fa-arrow-trend-down"></i> Despesas (Mês)</div>
                <div class="stat-value" style="word-break: break-word; overflow-wrap: break-word;">${formatCurrencyCompact(monthlyExpenses)}</div>
                <div class="stat-change">${expenses.filter(e => e.date.startsWith(new Date().toISOString().slice(0, 7))).length} lançamentos</div>
            </div>
            <div class="stat-box">
                <div class="stat-label"><i class="fas fa-calendar-days"></i> Dias Alugados</div>
                <div class="stat-value">${rentedDaysCount}</div>
                <div class="stat-change">este mês</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-key"></i> Próxima Locação</div>
            </div>
            ${nextRental ? `
                <div style="padding: 0;">
                    <div style="font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem;">${nextRental.clientName}</div>
                    <div style="color: var(--cinza-500); margin-bottom: 1rem;">
                        ${formatDate(nextRental.startDate)} a ${formatDate(nextRental.endDate)} (${nextRental.days} dias)
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 800; color: var(--verde-principal); word-break: break-word; overflow-wrap: break-word;" title="${formatCurrency(nextRental.total)}">${formatCurrencyCompact(nextRental.total)}</div>
                </div>
            ` : '<div class="empty-state"><i class="fas fa-inbox"></i><p>Nenhuma locação agendada</p></div>'}
        </div>
    `;

            setTimeout(() => {
                document.querySelectorAll('.stat-box-clickable').forEach(box => {
                    box.removeEventListener('click', handleStatBoxClick);
                    box.addEventListener('click', handleStatBoxClick);
                });
            }, 0);

            return html;
        }

        function handleStatBoxClick(e) {
            const statType = this.dataset.stat;
            openEditStatModal(statType);
        }

        function openEditStatModal(statType) {
            const capital = calculateCapital();
            const monthlyRevenue = calculateMonthlyRevenue();
            const monthlyExpenses = calculateMonthlyExpenses();

            let title = '';
            let currentValue = 0;
            let helpText = '';
            let icon = '';

            if (statType === 'capital') {
                title = 'Editar Capital Inicial';
                currentValue = settings.initialCapital;
                helpText = 'Ajuste seu capital inicial. O capital atual é calculado automaticamente.';
                icon = 'fa-wallet';
            }
            else if (statType === 'revenue') {
                title = 'Receita do Mês';
                currentValue = monthlyRevenue;
                helpText = 'A receita é calculada automaticamente pelas locações deste mês';
                icon = 'fa-arrow-trend-up';
            }
            else if (statType === 'expenses') {
                title = 'Despesas do Mês';
                currentValue = monthlyExpenses;
                helpText = 'As despesas são calculadas automaticamente pelos lançamentos deste mês';
                icon = 'fa-arrow-trend-down';
            }

            const modalHTML = `
        <div class="modal-header">
            <i class="fas ${icon}"></i>
            <span>${title}</span>
        </div>

        <p class="modal-help">
            ${helpText}
        </p>

        <div class="form-group">
            <label class="form-label">
                Valor ${statType === 'capital' ? 'Atual' : 'Calculado'}: ${formatCurrency(currentValue)}
            </label>

            <input
                type="number"
                id="editStatInput"
                class="form-input"
                step="0.01"
                value="${statType === 'capital' ? settings.initialCapital : currentValue}"
                ${statType !== 'capital' ? 'disabled' : ''}
            >
        </div>

        <div class="modal-info">
            <i class="fas fa-info-circle"></i>
            <span>${statType === 'capital' ? 'Alterar o capital inicial reflete no dashboard.' : 'Este valor é calculado automaticamente.'}</span>
        </div>

        <div class="modal-buttons">
            <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="saveEditStat('${statType}')" ${statType !== 'capital' ? 'disabled' : ''}>
                Salvar
            </button>
        </div>
    `;

            const modalContent = document.getElementById('modalContent');
            if (!modalContent) {
                console.error('modalContent não encontrado');
                return;
            }

            modalContent.innerHTML = modalHTML;

            document.getElementById('modalBackdrop').classList.add('show');
            document.getElementById('modal').classList.add('show');

            setTimeout(() => {
                const input = document.getElementById('editStatInput');
                if (input && !input.disabled) {
                    input.focus();
                    input.select();
                }
            }, 150);
        }

        function saveEditStat(statType) {
            if (statType !== 'capital') {
                showToast('Este valor é calculado automaticamente', 'warning');
                closeModal();
                return;
            }

            const newValue = parseFloat(document.getElementById('editStatInput').value) || 0;

            if (newValue < 0) {
                showToast('❌ Valor não pode ser negativo', 'error');
                return;
            }

            const oldCapital = settings.initialCapital;
            settings.initialCapital = newValue;
            saveSettings();
            closeModal();
            refreshDashboard();
            showToast(`✅ Capital inicial atualizado de ${formatCurrency(oldCapital)} para ${formatCurrency(newValue)}`, 'success');
        }

        function refreshDashboard() {
            const content = document.getElementById('content');
            if (!content) return;

            content.innerHTML = renderDashboard();
        }

        // ===== CALENDAR =====
        function renderCalendar() {
            const year = currentMonthYear.getFullYear();
            const month = currentMonthYear.getMonth();
            const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];

            let html = `
        <div class="card" style="width: 100%; max-width: 100%; padding: 0.5rem; box-sizing: border-box;">
            <div class="card-header" style="display: flex; align-items: center; justify-content: space-between; gap: 0.25rem; margin-bottom: 0.75rem; flex-wrap: nowrap;">
                <button class="btn btn-secondary btn-small" onclick="prevMonth()" style="padding: 0.35rem; min-width: 32px; height: 32px; flex-shrink: 0;"><i class="fas fa-chevron-left" style="font-size: clamp(0.7rem, 2vw, 1rem);"></i></button>
                <div class="card-title" style="margin-bottom: 0; flex: 1; text-align: center; font-size: clamp(0.85rem, 3.5vw, 1.1rem); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <i class="fas fa-calendar-alt"></i> ${monthNames[month]} ${year}
                </div>
                <button class="btn btn-secondary btn-small" onclick="nextMonth()" style="padding: 0.35rem; min-width: 32px; height: 32px; flex-shrink: 0;"><i class="fas fa-chevron-right" style="font-size: clamp(0.7rem, 2vw, 1rem);"></i></button>
            </div>

            <div class="calendar-header" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.15rem; margin-bottom: 0.35rem; width: 100%; box-sizing: border-box;">
    `;

            dayNames.forEach(day => {
                html += `<div class="calendar-day-name" style="text-align: center; font-weight: 600; font-size: clamp(0.65rem, 2.2vw, 0.8rem); padding: 0.35rem 0.15rem; overflow: hidden; text-overflow: ellipsis;">${day}</div>`;
            });

            html += `</div><div class="calendar" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.15rem; width: 100%; box-sizing: border-box;">`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < firstDay; i++) {
                html += `<div style="aspect-ratio: 1; width: 100%;"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const currentDate = new Date(dateStr + 'T00:00:00');
                const isRented = isDateRented(dateStr);
                const isReserved = isDateReserved(dateStr);
                const isSelected = selectedDays.includes(dateStr);
                const isPast = currentDate < today;

                let classes = 'calendar-day';
                let bgColor = '#ffffff';
                let textColor = '#333333';
                let cursor = 'pointer';
                let opacity = '1';

                if (isPast) {
                    classes += ' disabled';
                    bgColor = '#f0f0f0';
                    textColor = '#999999';
                    cursor = 'not-allowed';
                    opacity = '0.6';
                } else if (isRented) {
                    classes += ' rented';
                    bgColor = '#ff6b6b';
                    textColor = '#ffffff';
                    cursor = 'not-allowed';
                } else if (isReserved) {
                    classes += ' reserved';
                    bgColor = '#ffa500';
                    textColor = '#ffffff';
                    cursor = 'not-allowed';
                } else if (isSelected) {
                    classes += ' selected';
                    bgColor = '#4CAF50';
                    textColor = '#ffffff';
                } else {
                    classes += ' available';
                    bgColor = '#e8f5e9';
                }

                const onclick = isPast || isRented || isReserved ? '' : `onclick="toggleDay('${dateStr}')"`;
                html += `
            <div class="${classes}" ${onclick} style="
                aspect-ratio: 1;
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 0.35rem;
                background-color: ${bgColor};
                color: ${textColor};
                font-weight: 600;
                font-size: clamp(0.65rem, 2.5vw, 0.85rem);
                cursor: ${cursor};
                opacity: ${opacity};
                transition: all 0.2s ease;
                border: 2px solid transparent;
                user-select: none;
                box-sizing: border-box;
                min-height: 30px;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                ${day}
            </div>
        `;
            }

            html += `</div></div>`;

            if (selectedDays.length > 0) {
                const diasSelecionados = selectedDays.length;
                const dataInicial = formatDate(selectedDays[0]);
                const dataFinal = formatDate(selectedDays[selectedDays.length - 1]);

                html += `
            <div class="card" style="width: 100%; max-width: 100%; padding: 0.75rem; box-sizing: border-box; margin-top: 0.75rem;">
                <div class="card-header" style="margin-bottom: 0.75rem;">
                    <div class="card-title" style="margin-bottom: 0; font-size: clamp(0.85rem, 3.5vw, 1rem);"><i class="fas fa-check-circle"></i> Período Selecionado</div>
                </div>
                <div style="margin-bottom: 0.75rem; width: 100%; box-sizing: border-box;">
                    <div style="font-weight: 700; margin-bottom: 0.35rem; font-size: clamp(0.8rem, 3.5vw, 0.95rem);">${diasSelecionados} dias</div>
                    <div style="color: var(--cinza-500); font-size: clamp(0.75rem, 3vw, 0.85rem);">
                        ${dataInicial} a ${dataFinal}
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; width: 100%; box-sizing: border-box;">
                    <button class="btn btn-primary" onclick="openRentalFlow()" style="width: 100%; padding: 0.6rem 0.5rem; font-size: clamp(0.75rem, 3vw, 0.9rem); box-sizing: border-box; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <i class="fas fa-plus"></i> Alugar
                    </button>
                    <button class="btn btn-secondary" onclick="openReserveFlow()" style="width: 100%; padding: 0.6rem 0.5rem; font-size: clamp(0.75rem, 3vw, 0.9rem); box-sizing: border-box; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <i class="fas fa-bookmark"></i> Reservar
                    </button>
                </div>
            </div>
        `;
            }

            return html;
        }

        function toggleDay(dateStr) {
            const index = selectedDays.indexOf(dateStr);
            if (index > -1) {
                selectedDays.splice(index, 1);
                showToast('Data removida da seleção', 'info', 1500);
            } else {
                selectedDays.push(dateStr);
                showToast('Data adicionada à seleção', 'success', 1500);
            }
            selectedDays.sort();
            renderPage();
        }

        function isDateRented(dateStr) {
            return rentals.some(r => {
                const start = new Date(r.startDate);
                const end = new Date(r.endDate);
                const current = new Date(dateStr);
                return current >= start && current <= end;
            });
        }

        function isDateReserved(dateStr) {
            return reserves.some(r => {
                const start = new Date(r.startDate);
                const end = new Date(r.endDate);
                const current = new Date(dateStr);
                return current >= start && current <= end;
            });
        }

        function prevMonth() {
            currentMonthYear.setMonth(currentMonthYear.getMonth() - 1);
            renderPage();
        }

        function nextMonth() {
            currentMonthYear.setMonth(currentMonthYear.getMonth() + 1);
            renderPage();
        }

        function openRentalFlow() {
            if (selectedDays.length === 0) {
                showToast('Selecione pelo menos um dia', 'warning', 2000);
                return;
            }
            populateClientSelect();
            openModal('rentalModal');
        }

        function openReserveFlow() {
            if (selectedDays.length === 0) {
                showToast('Selecione pelo menos um dia', 'warning', 2000);
                return;
            }
            populateClientSelect();
            openModal('reserveModal');
        }

        // ===== RENTALS =====
        function renderRentals() {
            if (rentals.length === 0) {
                return `<div class="card"><div class="empty-state"><i class="fas fa-inbox"></i><p>Nenhuma locação registrada</p></div></div>`;
            }

            const itemsPerPage = 10;
            const currentPage = window.rentalCurrentPage || 1;
            const sortedRentals = [...rentals].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const totalPages = Math.ceil(sortedRentals.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const paginatedRentals = sortedRentals.slice(startIndex, startIndex + itemsPerPage);

            let html = `
        <style>
            @media (max-width: 768px) {
                .rentals-table-wrapper { display: none; }
                .rentals-mobile-wrapper { display: block; }
            }
            @media (min-width: 769px) {
                .rentals-table-wrapper { display: block; }
                .rentals-mobile-wrapper { display: none; }
            }
        </style>

        <!-- DESKTOP TABLE VIEW -->
        <div class="rentals-table-wrapper">
            <div class="card">
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: var(--cinza-100);">
                                <th style="padding: 1rem; text-align: left; font-weight: 700; color: var(--cinza-700); border-bottom: 2px solid var(--border-color); font-size: 0.85rem;"><i class="fas fa-user"></i> Cliente</th>
                                <th style="padding: 1rem; text-align: left; font-weight: 700; color: var(--cinza-700); border-bottom: 2px solid var(--border-color); font-size: 0.85rem;"><i class="fas fa-calendar"></i> Período</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 700; color: var(--cinza-700); border-bottom: 2px solid var(--border-color); font-size: 0.85rem;"><i class="fas fa-calculator"></i> Dias</th>
                                <th style="padding: 1rem; text-align: right; font-weight: 700; color: var(--cinza-700); border-bottom: 2px solid var(--border-color); font-size: 0.85rem;"><i class="fas fa-tag"></i> Diária</th>
                                <th style="padding: 1rem; text-align: right; font-weight: 700; color: var(--cinza-700); border-bottom: 2px solid var(--border-color); font-size: 0.85rem;"><i class="fas fa-money-bill"></i> Total</th>
                                <th style="padding: 1rem; text-align: center; font-weight: 700; color: var(--cinza-700); border-bottom: 2px solid var(--border-color); font-size: 0.85rem;"><i class="fas fa-info-circle"></i> Status</th>
                            </tr>
                        </thead>
                        <tbody>
    `;

            paginatedRentals.forEach(rental => {
                const status = new Date(rental.endDate) < new Date() ? 'Finalizado' : 'Ativo';
                const statusClass = status === 'Ativo' ? 'status-active' : 'status-finished';

                html += `
            <tr onclick="openEditRentalModal('${rental.id}')" style="cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid var(--border-color);" onmouseover="this.style.backgroundColor='var(--cinza-100)'" onmouseout="this.style.backgroundColor='transparent'">
                <td style="padding: 1rem; font-size: 0.95rem; font-weight: 600; color: var(--cinza-700);">${rental.clientName}</td>
                <td style="padding: 1rem; font-size: 0.95rem; color: var(--cinza-700);">${formatDate(rental.startDate)} a ${formatDate(rental.endDate)}</td>
                <td style="padding: 1rem; font-size: 0.95rem; text-align: center; font-weight: 600; color: var(--cinza-700);">${rental.days}</td>
                <td style="padding: 1rem; font-size: 0.95rem; text-align: right; font-weight: 600; color: var(--cinza-700);">${formatCurrency(rental.dailyRate)}</td>
                <td style="padding: 1rem; font-size: 0.95rem; text-align: right; font-weight: 800; color: var(--verde-principal);">${formatCurrency(rental.total)}</td>
                <td style="padding: 1rem; text-align: center;">
                    <span class="status-badge ${statusClass}" style="display: inline-block; padding: 0.4rem 0.8rem; border-radius: 0.4rem; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; white-space: nowrap;">${status}</span>
                </td>
            </tr>
        `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; padding: 1.5rem; border-top: 1px solid var(--border-color); flex-wrap: wrap;">
                    <div style="color: var(--cinza-500); font-size: 0.9rem;">
                        Mostrando <strong>${startIndex + 1}</strong> a <strong>${Math.min(startIndex + itemsPerPage, sortedRentals.length)}</strong> de <strong>${sortedRentals.length}</strong>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button onclick="changeRentalPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="btn btn-secondary btn-small" style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); background-color: ${currentPage === 1 ? 'var(--cinza-100)' : 'white'}; color: var(--cinza-700); cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; opacity: ${currentPage === 1 ? '0.5' : '1'}; transition: all 0.2s ease;" onmouseover="${currentPage !== 1 ? "this.style.backgroundColor='var(--cinza-100)'" : ''}" onmouseout="${currentPage !== 1 ? "this.style.backgroundColor='white'" : ''}">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <div style="display: flex; gap: 0.25rem; align-items: center;">
                            ${Array.from({ length: Math.min(3, totalPages) }, (_, i) => {
                const page = currentPage <= 2 ? i + 1 : currentPage >= totalPages - 1 ? totalPages - 2 + i : currentPage - 1 + i;
                if (page > 0 && page <= totalPages) {
                    return `<button onclick="changeRentalPage(${page})" style="padding: 0.5rem 0.75rem; background-color: ${page === currentPage ? 'var(--verde-principal)' : 'white'}; color: ${page === currentPage ? 'white' : 'var(--cinza-700)'}; border: 1px solid var(--border-color); border-radius: 0.35rem; font-weight: 600; font-size: 0.9rem; min-width: 2.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='${page === currentPage ? 'var(--verde-principal)' : 'var(--cinza-100)'}'" onmouseout="this.style.backgroundColor='${page === currentPage ? 'var(--verde-principal)' : 'white'}'">
                                ${page}
                            </button>`;
                }
                return '';
            }).join('')}
                            ${totalPages > 3 ? `<span style="color: var(--cinza-500);">...</span>` : ''}
                            ${totalPages > 3 ? `<button onclick="changeRentalPage(${totalPages})" style="padding: 0.5rem 0.75rem; background-color: ${currentPage === totalPages ? 'var(--verde-principal)' : 'white'}; color: ${currentPage === totalPages ? 'white' : 'var(--cinza-700)'}; border: 1px solid var(--border-color); border-radius: 0.35rem; font-weight: 600; font-size: 0.9rem; min-width: 2.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.backgroundColor='${currentPage === totalPages ? 'var(--verde-principal)' : 'var(--cinza-100)'}'" onmouseout="this.style.backgroundColor='${currentPage === totalPages ? 'var(--verde-principal)' : 'white'}'">
                                ${totalPages}
                            </button>` : ''}
                        </div>
                        <button onclick="changeRentalPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="btn btn-secondary btn-small" style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); background-color: ${currentPage === totalPages ? 'var(--cinza-100)' : 'white'}; color: var(--cinza-700); cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; opacity: ${currentPage === totalPages ? '0.5' : '1'}; transition: all 0.2s ease;" onmouseover="${currentPage !== totalPages ? "this.style.backgroundColor='var(--cinza-100)'" : ''}" onmouseout="${currentPage !== totalPages ? "this.style.backgroundColor='white'" : ''}">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MOBILE CARD VIEW -->
        <div class="rentals-mobile-wrapper">
            <div style="display: grid; gap: 1rem; padding: 0;">
    `;

            paginatedRentals.forEach(rental => {
                const status = new Date(rental.endDate) < new Date() ? 'Finalizado' : 'Ativo';
                const statusClass = status === 'Ativo' ? 'status-active' : 'status-finished';

                html += `
            <div class="card" onclick="openEditRentalModal('${rental.id}')" style="cursor: pointer; padding: 1.25rem; border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; transform: translateY(0);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)'">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--cinza-700); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user" style="color: var(--verde-principal);"></i>
                            ${rental.clientName}
                        </div>
                    </div>
                    <span class="status-badge ${statusClass}" style="display: inline-block; padding: 0.35rem 0.7rem; border-radius: 0.4rem; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; white-space: nowrap;">${status}</span>
                </div>

                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                        <i class="fas fa-calendar-alt" style="color: var(--verde-principal); margin-top: 0.25rem; min-width: 20px;"></i>
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: var(--cinza-500); font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Período</div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: var(--cinza-700);">${formatDate(rental.startDate)} a ${formatDate(rental.endDate)}</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                            <i class="fas fa-calculator" style="color: var(--verde-principal); margin-top: 0.25rem; min-width: 20px;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--cinza-500); font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Dias</div>
                                <div style="font-size: 0.95rem; font-weight: 600; color: var(--cinza-700);">${rental.days}</div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 0.75rem; align-items: flex-start;">
                            <i class="fas fa-tag" style="color: var(--verde-principal); margin-top: 0.25rem; min-width: 20px;"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; color: var(--cinza-500); font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Diária</div>
                                <div style="font-size: 0.95rem; font-weight: 600; color: var(--cinza-700);">${formatCurrency(rental.dailyRate)}</div>
                            </div>
                        </div>
                    </div>

                    <div style="padding-top: 0.75rem; border-top: 2px solid var(--cinza-100); display: flex; gap: 0.75rem; align-items: flex-start;">
                        <i class="fas fa-money-bill" style="color: var(--verde-principal); margin-top: 0.25rem; min-width: 20px;"></i>
                        <div style="flex: 1;">
                            <div style="font-size: 0.75rem; color: var(--cinza-500); font-weight: 600; text-transform: uppercase; margin-bottom: 0.25rem;">Total</div>
                            <div style="font-size: 1.2rem; font-weight: 800; color: var(--verde-principal);">${formatCurrency(rental.total)}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
            });

            html += `
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 0.75rem; margin-top: 1.5rem; flex-wrap: wrap; padding: 0 0.5rem;">
                <div style="color: var(--cinza-500); font-size: 0.85rem; width: 100%; text-align: center; margin-bottom: 0.5rem;">
                    <strong>${startIndex + 1}</strong> a <strong>${Math.min(startIndex + itemsPerPage, sortedRentals.length)}</strong> de <strong>${sortedRentals.length}</strong>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center; width: 100%;">
                    <button onclick="changeRentalPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); background-color: ${currentPage === 1 ? 'var(--cinza-100)' : 'white'}; color: var(--cinza-700); cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; border-radius: 0.35rem; font-weight: 600; opacity: ${currentPage === 1 ? '0.5' : '1'};" onmouseover="${currentPage !== 1 ? "this.style.backgroundColor='var(--cinza-100)'" : ''}" onmouseout="${currentPage !== 1 ? "this.style.backgroundColor='white'" : ''}">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div style="display: flex; gap: 0.25rem;">
                        ${Array.from({ length: Math.min(3, totalPages) }, (_, i) => {
                const page = currentPage <= 2 ? i + 1 : currentPage >= totalPages - 1 ? totalPages - 2 + i : currentPage - 1 + i;
                if (page > 0 && page <= totalPages) {
                    return `<button onclick="changeRentalPage(${page})" style="padding: 0.4rem 0.6rem; background-color: ${page === currentPage ? 'var(--verde-principal)' : 'white'}; color: ${page === currentPage ? 'white' : 'var(--cinza-700)'}; border: 1px solid var(--border-color); border-radius: 0.35rem; font-weight: 600; font-size: 0.85rem; min-width: 2.2rem; cursor: pointer;" onmouseover="this.style.backgroundColor='${page === currentPage ? 'var(--verde-principal)' : 'var(--cinza-100)'}'" onmouseout="this.style.backgroundColor='${page === currentPage ? 'var(--verde-principal)' : 'white'}'">
                            ${page}
                        </button>`;
                }
                return '';
            }).join('')}
                    </div>
                    <button onclick="changeRentalPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 0.5rem 0.75rem; border: 1px solid var(--border-color); background-color: ${currentPage === totalPages ? 'var(--cinza-100)' : 'white'}; color: var(--cinza-700); cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; border-radius: 0.35rem; font-weight: 600; opacity: ${currentPage === totalPages ? '0.5' : '1'};" onmouseover="${currentPage !== totalPages ? "this.style.backgroundColor='var(--cinza-100)'" : ''}" onmouseout="${currentPage !== totalPages ? "this.style.backgroundColor='white'" : ''}">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    `;

            return html;
        }

        function changeRentalPage(page) {
            window.rentalCurrentPage = page;
            renderPage();
        }

        function openEditRentalModal(id) {
            currentEditingRentalId = id;
            const rental = rentals.find(r => r.id === id);
            if (rental) {
                document.getElementById('editRentalClientName').value = rental.clientName;
                document.getElementById('editRentalStartDate').value = rental.startDate;
                document.getElementById('editRentalEndDate').value = rental.endDate;
                document.getElementById('editRentalDailyRate').value = rental.dailyRate;
                calcEditRentalTotal();
                openModal('editRentalModal');
                showToast('Locação aberta para edição', 'info', 1500);
            } else {
                showToast('Erro ao carregar locação', 'error', 2000);
            }
        }

        function calcEditRentalTotal() {
            const startDate = new Date(document.getElementById('editRentalStartDate').value);
            const endDate = new Date(document.getElementById('editRentalEndDate').value);
            const dailyRate = parseFloat(document.getElementById('editRentalDailyRate').value) || 0;

            if (startDate && endDate && startDate <= endDate) {
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                const total = dailyRate * days;
                document.getElementById('editRentalTotal').value = formatCurrency(total);
                document.getElementById('editRentalDays').value = days;
            } else {
                showToast('Datas inválidas', 'warning', 1500);
            }
        }

        function saveEditRental() {
            const clientName = document.getElementById('editRentalClientName').value.trim();
            const startDate = document.getElementById('editRentalStartDate').value;
            const endDate = document.getElementById('editRentalEndDate').value;
            const dailyRate = parseFloat(document.getElementById('editRentalDailyRate').value);

            if (!clientName) {
                showToast('Digite o nome do cliente', 'warning', 2000);
                return;
            }

            if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                showToast('Datas inválidas', 'warning', 2000);
                return;
            }

            if (!dailyRate || dailyRate <= 0) {
                showToast('Diária deve ser maior que zero', 'warning', 2000);
                return;
            }

            const rental = rentals.find(r => r.id === currentEditingRentalId);
            if (rental) {
                const days = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;

                rental.clientName = clientName;
                rental.startDate = startDate;
                rental.endDate = endDate;
                rental.dailyRate = dailyRate;
                rental.days = days;
                rental.total = dailyRate * days;

                triggerSync('rental_updated', { id: currentEditingRentalId, rental });
                closeModal('editRentalModal');
                renderPage();
                showToast(`✅ Locação de ${clientName} atualizada com sucesso!`, 'success', 2000);
            }
        }

        function deleteCurrentRental() {
            const rental = rentals.find(r => r.id === currentEditingRentalId);
            showConfirmModal(
                'Cancelar Locação',
                `Deseja cancelar a locação de ${rental?.clientName}? Esta ação não pode ser desfeita.`,
                () => {
                    rentals = rentals.filter(r => r.id !== currentEditingRentalId);
                    triggerSync('rental_deleted', { id: currentEditingRentalId });
                    closeModal('editRentalModal');
                    renderPage();
                    showToast(`✅ Locação cancelada com sucesso!`, 'success', 2000);
                }
            );
        }

        // ===== EXPENSES =====
        function renderExpenses() {
            let html = '<div class="card"><div class="category-grid">';

            Object.keys(categories).forEach(catKey => {
                const cat = categories[catKey];
                const catExpenses = expenses.filter(e => e.category === catKey);
                const total = catExpenses.reduce((sum, e) => sum + e.amount, 0);

                html += `
            <div class="category-card" onclick="openCategoryHistory('${catKey}')" style="position: relative;">
                <button class="category-add-btn" onclick="event.stopPropagation(); openQuickAdd('${catKey}')" style="position: absolute; top: -0.75rem; right: -0.75rem; width: 2.5rem; height: 2.5rem; border-radius: 50%; background-color: var(--verde-principal); color: white; border: none; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);" onmouseover="this.style.backgroundColor='#059669'; this.style.transform='scale(1.1)'" onmouseout="this.style.backgroundColor='var(--verde-principal)'; this.style.transform='scale(1)'">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="category-icon"><i class="${cat.icon}"></i></div>
                <div class="category-name">${cat.name}</div>
                <div class="category-total">${formatCurrency(total)}</div>
                <div style="color: var(--cinza-500); font-size: 0.8rem; margin-bottom: 1rem;">
                    ${catExpenses.length} lançamento${catExpenses.length !== 1 ? 's' : ''}
                </div>
                <button onclick="event.stopPropagation(); openQuickAdd('${catKey}')" style="width: 100%; padding: 0.75rem; background-color: var(--verde-principal); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" onmouseover="this.style.backgroundColor='#059669'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.backgroundColor='var(--verde-principal)'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <i class="fas fa-plus"></i> Lançar
                </button>
            </div>
        `;
            });

            html += '</div></div>';
            return html;
        }

        function openQuickAdd(category) {
            currentEditingCategory = category;
            document.getElementById('quickAddTitle').textContent = `Lançar - ${categories[category].name}`;
            document.getElementById('quickAmount').value = '';
            document.getElementById('quickDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('quickNote').value = '';
            document.getElementById('quickAddForm').onsubmit = (e) => submitQuickAdd(e, category);
            openModal('quickAddModal');
        }

        function submitQuickAdd(e, category) {
            e.preventDefault();

            const amount = parseFloat(document.getElementById('quickAmount').value);
            const date = document.getElementById('quickDate').value;
            const note = document.getElementById('quickNote').value.trim();

            if (!amount || amount <= 0) {
                showToast('Digite um valor válido', 'warning', 2000);
                return;
            }

            if (!date) {
                showToast('Selecione uma data', 'warning', 2000);
                return;
            }

            const expense = {
                id: Date.now().toString(),
                category,
                amount: amount,
                date: date,
                note: note,
                createdAt: new Date().toISOString()
            };

            expenses.push(expense);
            triggerSync('expense_created', { expense });
            closeModal('quickAddModal');
            renderPage();
            showToast(`✅ Gasto de ${formatCurrency(expense.amount)} lançado!`, 'success', 2000);
        }

        function openCategoryHistory(category) {
            currentEditingCategory = category;
            const cat = categories[category];
            const catExpenses = expenses.filter(e => e.category === category).sort((a, b) => new Date(b.date) - new Date(a.date));

            document.getElementById('historyTitle').textContent = cat.name;
            let historyHtml = '';

            if (catExpenses.length === 0) {
                historyHtml = '<div class="empty-state"><i class="fas fa-history"></i><p>Nenhum lançamento</p></div>';
            } else {
                historyHtml = '<div class="table-container"><table><thead><tr><th><i class="fas fa-calendar"></i> Data</th><th><i class="fas fa-file-alt"></i> Observação</th><th style="text-align: right;"><i class="fas fa-money-bill"></i> Valor</th></tr></thead><tbody>';
                catExpenses.forEach(exp => {
                    historyHtml += `
                <tr onclick="openEditExpense('${exp.id}')">
                    <td style="font-weight: 700; color: var(--verde-principal);">${formatDate(exp.date)}</td>
                    <td>${exp.note || '-'}</td>
                    <td style="text-align: right; font-weight: 800; color: var(--verde-principal);">${formatCurrency(exp.amount)}</td>
                </tr>
            `;
                });
                historyHtml += '</tbody></table></div>';
            }

            document.getElementById('historyList').innerHTML = historyHtml;
            openModal('historyModal');
        }

        function openEditExpense(id) {
            currentEditingExpenseId = id;
            const exp = expenses.find(e => e.id === id);
            if (exp) {
                document.getElementById('editAmount').value = exp.amount;
                document.getElementById('editDate').value = exp.date;
                document.getElementById('editNote').value = exp.note;
                closeModal('historyModal');
                openModal('editExpenseModal');
                showToast('Lançamento aberto para edição', 'info', 1500);
            } else {
                showToast('Erro ao carregar lançamento', 'error', 2000);
            }
        }

        function saveEditExpense() {
            const amount = parseFloat(document.getElementById('editAmount').value);
            const date = document.getElementById('editDate').value;
            const note = document.getElementById('editNote').value.trim();

            if (!amount || amount <= 0) {
                showToast('Digite um valor válido', 'warning', 2000);
                return;
            }

            if (!date) {
                showToast('Selecione uma data', 'warning', 2000);
                return;
            }

            const expense = expenses.find(e => e.id === currentEditingExpenseId);
            if (expense) {
                expense.amount = amount;
                expense.date = date;
                expense.note = note;

                triggerSync('expense_updated', { id: currentEditingExpenseId, expense });
                closeModal('editExpenseModal');
                renderPage();
                showToast(`✅ Lançamento atualizado para ${formatCurrency(amount)}!`, 'success', 2000);
            }
        }

        function deleteCurrentExpense() {
            showConfirmModal(
                'Excluir Lançamento',
                'Esta ação não pode ser desfeita. Deseja excluir esse lançamento?',
                () => {
                    expenses = expenses.filter(e => e.id !== currentEditingExpenseId);
                    triggerSync('expense_deleted', { id: currentEditingExpenseId });
                    closeModal('editExpenseModal');
                    renderPage();
                    showToast(`✅ Lançamento excluído com sucesso!`, 'success', 2000);
                }
            );
        }

        // ===== CLIENTS =====
        function renderClients() {
            let html = `<button class="btn btn-primary" onclick="openNewClientFlow()" style="margin-bottom: 1.5rem;">
        <i class="fas fa-user-plus"></i> Novo Cliente
    </button>`;

            if (clients.length === 0) {
                html += `<div class="card"><div class="empty-state"><i class="fas fa-users"></i><p>Nenhum cliente registrado</p></div></div>`;
            } else {
                html += '<div class="card"><div class="table-container"><table><thead><tr><th><i class="fas fa-user"></i> Nome</th><th><i class="fas fa-envelope"></i> Email</th><th><i class="fas fa-id-card"></i> CPF</th><th><i class="fas fa-phone"></i> Telefone</th></tr></thead><tbody>';
                clients.forEach(client => {
                    html += `
                <tr onclick="openEditClientModal('${client.id}')">
                    <td><strong>${client.name}</strong></td>
                    <td>${client.email || '-'}</td>
                    <td>${client.cpf || '-'}</td>
                    <td>${client.phone || '-'}</td>
                </tr>
            `;
                });
                html += '</tbody></table></div></div>';
            }

            return html;
        }

        function openNewClientFlow() {
            document.getElementById('editClientName').value = '';
            document.getElementById('editClientEmail').value = '';
            document.getElementById('editClientCPF').value = '';
            document.getElementById('editClientPhone').value = '';
            currentEditingClientId = null;
            openModal('clientModal');
        }

        function saveNewClient() {
            const name = document.getElementById('editClientName').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const cpf = document.getElementById('editClientCPF').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();

            if (!name) {
                showToast('Digite o nome do cliente', 'warning', 2000);
                return;
            }

            if (currentEditingClientId === null) {
                const newClient = {
                    id: Date.now().toString(),
                    name,
                    email,
                    cpf,
                    phone,
                    createdAt: new Date().toISOString()
                };

                clients.push(newClient);
                triggerSync('client_created', { client: newClient });
                closeModal('clientModal');
                renderPage();
                showToast(`✅ Cliente "${name}" criado com sucesso!`, 'success', 2000);
            }
        }

        function openEditClientModal(id) {
            currentEditingClientId = id;
            const client = clients.find(c => c.id === id);
            if (client) {
                document.getElementById('editClientName').value = client.name;
                document.getElementById('editClientEmail').value = client.email || '';
                document.getElementById('editClientCPF').value = client.cpf || '';
                document.getElementById('editClientPhone').value = client.phone || '';
                openModal('editClientModal');
                showToast('Cliente carregado para edição', 'info', 1500);
            } else {
                showToast('Erro ao carregar cliente', 'error', 2000);
            }
        }

        function saveEditClient() {
            const name = document.getElementById('editClientName').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const cpf = document.getElementById('editClientCPF').value.trim();
            const phone = document.getElementById('editClientPhone').value.trim();

            if (!name) {
                showToast('Digite o nome do cliente', 'warning', 2000);
                return;
            }

            const client = clients.find(c => c.id === currentEditingClientId);
            if (client) {
                client.name = name;
                client.email = email;
                client.cpf = cpf;
                client.phone = phone;

                triggerSync('client_updated', { id: currentEditingClientId, client });
                closeModal('editClientModal');
                renderPage();
                showToast(`✅ Cliente "${name}" atualizado com sucesso!`, 'success', 2000);
            }
        }

        function deleteCurrentClient() {
            const client = clients.find(c => c.id === currentEditingClientId);
            showConfirmModal(
                'Excluir Cliente',
                `Deseja excluir ${client?.name}? Locações e reservas serão mantidas no histórico.`,
                () => {
                    clients = clients.filter(c => c.id !== currentEditingClientId);
                    triggerSync('client_deleted', { id: currentEditingClientId });
                    closeModal('editClientModal');
                    renderPage();
                    showToast(`✅ Cliente "${client.name}" excluído com sucesso!`, 'success', 2000);
                }
            );
        }

        function populateClientSelect() {
            const select = document.getElementById('reserveClient');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione um cliente...</option>';

            if (clients.length === 0) {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'Nenhum cliente cadastrado';
                select.appendChild(option);
                showToast('Cadastre um cliente primeiro', 'warning', 2000);
                return;
            }

            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                select.appendChild(option);
            });
        }

        // ===== RESERVES =====
        function renderReserves() {
            if (reserves.length === 0) {
                return `<div class="card"><div class="empty-state"><i class="fas fa-bookmark"></i><p>Nenhuma reserva registrada</p></div></div>`;
            }

            let html = '<div class="card"><div class="table-container"><table><thead><tr><th><i class="fas fa-user"></i> Cliente</th><th><i class="fas fa-calendar"></i> Período</th><th style="text-align: center;"><i class="fas fa-calculator"></i> Dias</th><th style="text-align: right;"><i class="fas fa-tag"></i> Diária</th><th style="text-align: center;"><i class="fas fa-cog"></i> Ação</th></tr></thead><tbody>';

            reserves.forEach(reserve => {
                html += `
            <tr>
                <td><strong>${reserve.clientName}</strong></td>
                <td>${formatDate(reserve.startDate)} a ${formatDate(reserve.endDate)}</td>
                <td style="text-align: center; font-weight: 600;">${reserve.days}</td>
                <td style="text-align: right; font-weight: 600;">${formatCurrency(reserve.dailyRate)}</td>
                <td style="text-align: center;">
                    <button class="btn btn-primary btn-small" onclick="confirmReserveFlow('${reserve.id}')">
                        <i class="fas fa-check"></i> Confirmar
                    </button>
                </td>
            </tr>
        `;
            });

            html += '</tbody></table></div></div>';
            return html;
        }

        function confirmReserveFlow(id) {
            const reserve = reserves.find(r => r.id === id);
            if (!reserve) {
                showToast('Erro ao confirmar reserva', 'error', 2000);
                return;
            }

            showConfirmModal(
                'Confirmar Reserva',
                `Deseja converter a reserva de ${reserve.clientName} (${formatDate(reserve.startDate)} a ${formatDate(reserve.endDate)}) em uma locação?`,
                () => {
                    const rental = {
                        id: Date.now().toString(),
                        clientName: reserve.clientName,
                        startDate: reserve.startDate,
                        endDate: reserve.endDate,
                        days: reserve.days,
                        dailyRate: reserve.dailyRate,
                        total: reserve.dailyRate * reserve.days,
                        createdAt: new Date().toISOString()
                    };

                    rentals.push(rental);
                    reserves = reserves.filter(r => r.id !== id);
                    triggerSync('reserve_confirmed', { reserveId: id, rental });
                    renderPage();
                    showToast(`✅ Reserva de ${reserve.clientName} confirmada como locação!`, 'success', 2000);
                }
            );
        }

        function deleteCurrentReserve() {
            const reserve = reserves.find(r => r.id === currentEditingReserveId);
            showConfirmModal(
                'Cancelar Reserva',
                `Deseja cancelar a reserva de ${reserve?.clientName}? Esta ação não pode ser desfeita.`,
                () => {
                    reserves = reserves.filter(r => r.id !== currentEditingReserveId);
                    triggerSync('reserve_deleted', { id: currentEditingReserveId });
                    closeModal('editReserveModal');
                    renderPage();
                    showToast(`✅ Reserva cancelada com sucesso!`, 'success', 2000);
                }
            );
        }

        // ===== RENTAL CREATION =====
        function submitRentalForm() {
            const clientId = document.getElementById('rentalClient').value;
            const dailyRate = parseFloat(document.getElementById('rentalDailyRate').value);

            if (!clientId) {
                showToast('Selecione um cliente', 'warning', 2000);
                return;
            }

            if (!dailyRate || dailyRate <= 0) {
                showToast('Digite uma diária válida', 'warning', 2000);
                return;
            }

            if (selectedDays.length === 0) {
                showToast('Selecione pelo menos um dia', 'warning', 2000);
                return;
            }

            const client = clients.find(c => c.id === clientId);
            const startDate = selectedDays[0];
            const endDate = selectedDays[selectedDays.length - 1];
            const days = selectedDays.length;

            const rental = {
                id: Date.now().toString(),
                clientName: client.name,
                startDate,
                endDate,
                days,
                dailyRate,
                total: dailyRate * days,
                createdAt: new Date().toISOString()
            };

            rentals.push(rental);
            selectedDays = [];
            triggerSync('rental_created', { rental });
            closeModal('rentalModal');
            renderPage();
            showToast(`✅ Locação de ${client.name} criada com sucesso!`, 'success', 2000);
        }

        // ===== RESERVE CREATION =====
        function submitReserveForm() {
            const clientId = document.getElementById('reserveClient').value;
            const dailyRate = parseFloat(document.getElementById('reserveDailyRate').value);

            if (!clientId) {
                showToast('Selecione um cliente', 'warning', 2000);
                return;
            }

            if (!dailyRate || dailyRate <= 0) {
                showToast('Digite uma diária válida', 'warning', 2000);
                return;
            }

            if (selectedDays.length === 0) {
                showToast('Selecione pelo menos um dia', 'warning', 2000);
                return;
            }

            const client = clients.find(c => c.id === clientId);
            const startDate = selectedDays[0];
            const endDate = selectedDays[selectedDays.length - 1];
            const days = selectedDays.length;

            const reserve = {
                id: Date.now().toString(),
                clientName: client.name,
                startDate,
                endDate,
                days,
                dailyRate,
                createdAt: new Date().toISOString()
            };

            reserves.push(reserve);
            selectedDays = [];
            triggerSync('reserve_created', { reserve });
            closeModal('reserveModal');
            renderPage();
            showToast(`✅ Reserva de ${client.name} criada com sucesso!`, 'success', 2000);
        }



        // ===== NOTES =====
        function renderNotes() {
            let html = `<button class="btn btn-primary" onclick="openNewNoteFlow()" style="margin-bottom: 1.5rem;">
        <i class="fas fa-plus"></i> Nova Anotação
    </button>`;

            if (notes.length === 0) {
                html += `<div class="card"><div class="empty-state"><i class="fas fa-sticky-note"></i><p>Nenhuma anotação criada</p></div></div>`;
            } else {
                html += '<div class="notes-grid">';
                [...notes].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(note => {
                    html += `
                <div class="note-card">
                    <div class="note-header">
                        <div class="note-title">${note.title}</div>
                        <button class="note-delete" onclick="deleteNoteFlow('${note.id}')" type="button" title="Deletar anotação">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-date">${formatDate(note.createdAt.split('T')[0])}</div>
                </div>
            `;
                });
                html += '</div>';
            }

            return html;
        }

        function openNewNoteFlow() {
            openModal('addNoteModal');
        }

        function deleteNoteFlow(id) {
            const note = notes.find(n => n.id === id);
            if (!note) {
                showToast('Erro ao carregar anotação', 'error', 2000);
                return;
            }

            showConfirmModal(
                'Excluir Anotação',
                `Deseja excluir a anotação "${note.title}"? Esta ação não pode ser desfeita.`,
                () => {
                    deleteFromFirebase('notes', id);
                    notes = notes.filter(n => n.id !== id);
                    showToast('Anotação excluída com sucesso!', 'success', 2000);
                    renderPage();
                }
            );
        }

        // ===== REPORTS =====
        function renderReports() {
            return `
        <div class="pdf-selector">
            <label class="pdf-selector-label"><i class="fas fa-file-pdf"></i> Tipo de Relatório:</label>
            <select class="pdf-selector-select" id="pdfTypeSelect" onchange="pdfType = this.value">
                <option value="geral">Relatório Geral (Completo)</option>
                <option value="receitas">Receitas (Aluguéis)</option>
                <option value="despesas">Despesas Detalhadas</option>
                <option value="clientes">Clientes e Locações</option>
            </select>
            <button class="export-btn" onclick="exportReportPDF()">
                <i class="fas fa-download"></i> Exportar PDF
            </button>
        </div>

        <div class="card">
            <div class="card-header">
                <div class="card-title"><i class="fas fa-chart-bar"></i> Resumo do Negócio</div>
            </div>
            <div class="stats-grid" style="margin: 0;">
                <div class="stat-box">
                    <div class="stat-label">Capital Atual</div>
                    <div class="stat-value">${formatCurrency(calculateCapital())}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Receita Total</div>
                    <div class="stat-value">${formatCurrency(calculateTotalRevenue())}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Despesa Total</div>
                    <div class="stat-value">${formatCurrency(calculateTotalExpenses())}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Lucro Líquido</div>
                    <div class="stat-value">${formatCurrency(calculateTotalRevenue() - calculateTotalExpenses())}</div>
                </div>
            </div>
        </div>
    `;
        }

        function getMonthName() {
            return new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
        }

        function showToastMessage(message, type = 'success') {
            const toastMsg = document.createElement('div');
            const bgColor = type === 'success' ? '#10b981' : '#ef4444';
            const icon = type === 'success' ? '✓' : '✗';
            toastMsg.style.cssText = `position:fixed;top:20px;right:20px;background:${bgColor};color:white;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);font-weight:600;z-index:9999;font-size:14px;`;
            toastMsg.textContent = `${icon} ${message}`;
            document.body.appendChild(toastMsg);
            setTimeout(() => toastMsg.remove(), 3000);
        }

        async function exportReportPDF() {
            const pdfType = document.getElementById('pdfTypeSelect').value;
            const { jsPDF } = window.jspdf;
            const exportBtn = event.target.closest('.export-btn');
            const originalHTML = exportBtn.innerHTML;

            exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            exportBtn.disabled = true;

            const pdfContainer = document.createElement('div');
            pdfContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;';

            let pdfHTML = '';

            if (pdfType === 'geral' || pdfType === 'receitas') {
                pdfHTML += generateReceitasPageHTML();
            }

            if (pdfType === 'geral' || pdfType === 'despesas') {
                pdfHTML += generateDespesasPageHTML();
            }

            if (pdfType === 'geral' || pdfType === 'clientes') {
                pdfHTML += generateClientesPageHTML();
            }

            pdfContainer.innerHTML = pdfHTML;
            document.body.appendChild(pdfContainer);

            try {
                await new Promise(resolve => setTimeout(resolve, 500));

                const pages = pdfContainer.querySelectorAll('.pdf-page');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = 210;

                for (let i = 0; i < pages.length; i++) {
                    const canvas = await html2canvas(pages[i], {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff',
                        width: 793,
                        windowWidth: 793
                    });

                    const imgData = canvas.toDataURL('image/png');
                    const imgHeight = (canvas.height * pdfWidth) / canvas.width;

                    if (i > 0) {
                        pdf.addPage();
                    }

                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                }

                pdf.save(`relatorio-kaudan-${new Date().toISOString().split('T')[0]}.pdf`);
                showToastMessage('PDF exportado com sucesso!', 'success');
                exportBtn.innerHTML = originalHTML;
                exportBtn.disabled = false;
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                showToastMessage('Erro ao gerar PDF. Tente novamente!', 'error');
                exportBtn.innerHTML = originalHTML;
                exportBtn.disabled = false;
            } finally {
                document.body.removeChild(pdfContainer);
            }
        }
        // ===== PDF GENERATION FUNCTIONS =====
        const PDF_COLORS = {
            receitas: { primary: '#10b981', dark: '#047857', light: '#d1fae5', bg: '#f0fdf4' },
            despesas: { primary: '#f59e0b', dark: '#d97706', light: '#fed7aa', bg: '#fef3c7' },
            clientes: { primary: '#3b82f6', dark: '#1e40af', light: '#bfdbfe', bg: '#eff6ff' }
        };

        function getPDFPageBase(type, title, subtitle, icon) {
            const colors = PDF_COLORS[type] || PDF_COLORS.receitas;

            return {
                getHeader: () => `
            <div style="background: linear-gradient(135deg, ${colors.primary} 0%, ${colors.dark} 100%); color: white; padding: 20px 36px; display: flex; justify-content: space-between; align-items: center; gap: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div style="flex: 1;">
                    <div style="font-size: 18px; font-weight: 900; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px;"><i class="fas fa-${icon}"></i> ${title}</div>
                    <div style="font-size: 13px; font-weight: 600; opacity: 0.95; display: flex; gap: 16px; align-items: center;">
                        <div>${subtitle}</div>
                        <div style="display: flex; gap: 12px; opacity: 0.85; font-size: 12px;">
                            <div><i class="fas fa-building" style="margin-right: 3px;"></i>Recanto KauDan</div>
                            <div><i class="fas fa-calendar-days" style="margin-right: 3px;"></i>${new Date().toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                </div>
                <div style="text-align: center; opacity: 0.95; border-left: 3px solid rgba(255,255,255,0.3); padding-left: 20px;">
                    <div style="font-size: 12px; font-weight: 700; margin-bottom: 6px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.3px;">Período</div>
                    <div style="font-size: 16px; font-weight: 900;">${getMonthName()}</div>
                </div>
            </div>
        `,
                getFooter: (pageNum, totalPages, info = '') => `
            <div style="padding: 12px 36px; border-top: 3px solid ${colors.light}; background: #fafafa; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #64748b; font-weight: 600;">
                <div><i class="fas fa-info-circle" style="margin-right: 4px; color: ${colors.primary};"></i> ${info || 'Relatório gerado automaticamente'}</div>
                <div><span style="color: ${colors.primary}; font-weight: 900;">Página ${pageNum}</span> de ${totalPages}</div>
            </div>
        `,
                getEmptyState: () => `
            <div class="pdf-page" style="width: 210mm; height: 297mm; background: #f8fafc; color: #111827; font-family: 'Segoe UI', -apple-system, sans-serif; padding: 0; margin-bottom: 20px; display: flex; flex-direction: column;">
                ${getPDFPageBase(type, title, subtitle, icon).getHeader()}
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 50px; text-align: center;">
                    <div style="font-size: 120px; color: #cbd5e1; margin-bottom: 24px;"><i class="fas fa-inbox"></i></div>
                    <div style="font-size: 20px; font-weight: 700; color: #64748b; margin-bottom: 12px;">Sem dados para exibir</div>
                    <div style="font-size: 15px; color: #94a3b8;">Adicione registros para gerar este relatório</div>
                </div>
            </div>
        `
            };
        }

        function generateReceitasPageHTML() {
            const totalReceita = calculateTotalRevenue();
            const monthlyRevenue = calculateMonthlyRevenue();
            const sortedRentals = [...rentals].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
            const colors = PDF_COLORS.receitas;
            const base = getPDFPageBase('receitas', 'ALUGUÉIS', 'Relatório de Receitas', 'key');

            if (sortedRentals.length === 0) {
                return base.getEmptyState();
            }

            let pagesHTML = '';
            let currentPage = [];
            const rowsPerPage = 25;

            sortedRentals.forEach((rental, idx) => {
                currentPage.push(rental);
                if (currentPage.length === rowsPerPage || idx === sortedRentals.length - 1) {
                    const pageNum = Math.floor(idx / rowsPerPage) + 1;
                    const totalPages = Math.ceil(sortedRentals.length / rowsPerPage);

                    const metricsCards = pageNum === 1 ? `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 14px;">
                    <div style="background: linear-gradient(135deg, ${colors.primary}15 0%, ${colors.primary}08 100%); border: 2px solid ${colors.light}; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.1);">
                        <div style="color: ${colors.primary}; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-money-bill-wave"></i></div>
                        <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">Total Receita</div>
                        <div style="color: ${colors.primary}; font-size: 14px; font-weight: 900;">${formatCurrency(totalReceita).replace('R$', '').trim()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f59e0b15 0%, #f59e0b08 100%); border: 2px solid #fef08a; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.1);">
                        <div style="color: #f59e0b; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-calendar-check"></i></div>
                        <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">Este Mês</div>
                        <div style="color: #f59e0b; font-size: 14px; font-weight: 900;">${formatCurrency(monthlyRevenue).replace('R$', '').trim()}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #a855f715 0%, #a855f708 100%); border: 2px solid #e9d5ff; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(168, 85, 247, 0.1);">
                        <div style="color: #a855f7; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-home"></i></div>
                        <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">Locações</div>
                        <div style="color: #a855f7; font-size: 14px; font-weight: 900;">${rentals.length}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #3b82f615 0%, #3b82f608 100%); border: 2px solid #bfdbfe; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);">
                        <div style="color: #3b82f6; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-chart-line"></i></div>
                        <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">Ticket Médio</div>
                        <div style="color: #3b82f6; font-size: 14px; font-weight: 900;">${formatCurrency(rentals.length > 0 ? totalReceita / rentals.length : 0).replace('R$', '').trim()}</div>
                    </div>
                </div>
            ` : '';

                    pagesHTML += `
                <div class="pdf-page" style="width: 210mm; height: 297mm; background: #f8fafc; color: #111827; font-family: 'Segoe UI', -apple-system, sans-serif; padding: 0; margin-bottom: 20px; display: flex; flex-direction: column;">
                    ${base.getHeader()}
                    <div style="padding: 14px 24px; flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;">
                        ${metricsCards}
                        <div style="border-bottom: 3px solid ${colors.primary}; padding-bottom: 6px;">
                            <div style="font-size: 13px; font-weight: 900; color: #0f172a; display: flex; align-items: center; gap: 8px;"><i class="fas fa-list-check"></i> ${pageNum > 1 ? 'PARTE ' + pageNum + ' - ' : ''}ALUGUÉIS</div>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, ${colors.primary} 0%, ${colors.dark} 100%); color: white; height: 28px;">
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Cliente</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Início</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Fim</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Dias</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Diária</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentPage.map((r, idx) => `
                                    <tr style="border-bottom: 2px solid ${idx === currentPage.length - 1 ? colors.primary : '#e5e7eb'}; background: ${idx % 2 === 0 ? '#ffffff' : colors.bg}; height: 24px;">
                                        <td style="padding: 6px 8px; font-weight: 700; color: ${colors.primary}; text-align: center; border-right: 1px solid #e5e7eb; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 10px;">${r.clientName.substring(0, 15)}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #475569; font-weight: 600; border-right: 1px solid #e5e7eb; font-size: 10px;">${formatDate(r.startDate)}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #475569; font-weight: 600; border-right: 1px solid #e5e7eb; font-size: 10px;">${formatDate(r.endDate)}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: ${colors.primary}; font-weight: 800; background: ${idx % 2 === 0 ? colors.bg : '#ecfdf5'}; border-right: 1px solid #e5e7eb; font-size: 10px;">${r.days}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #f59e0b; font-weight: 700; border-right: 1px solid #e5e7eb; font-size: 10px;">${formatCurrency(r.dailyRate).replace('R$', '').trim()}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-weight: 900; color: ${colors.primary}; background: ${idx % 2 === 0 ? colors.bg : '#ecfdf5'}; font-size: 10px;">${formatCurrency(r.total).replace('R$', '').trim()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${base.getFooter(pageNum, totalPages, `Total: ${formatCurrency(totalReceita)}`)}
                </div>
            `;
                    currentPage = [];
                }
            });

            return pagesHTML;
        }

        function generateDespesasPageHTML() {
            const totalDespesas = calculateTotalExpenses();
            const categoryTotals = {};
            expenses.forEach(exp => {
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + exp.amount;
            });

            const colors = PDF_COLORS.despesas;
            const base = getPDFPageBase('despesas', 'DESPESAS', 'Análise Detalhada de Gastos', 'receipt');

            if (expenses.length === 0) {
                return base.getEmptyState();
            }

            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
            let pagesHTML = '';
            let currentPage = [];
            const rowsPerPage = 25;

            sortedExpenses.forEach((exp, idx) => {
                currentPage.push(exp);
                if (currentPage.length === rowsPerPage || idx === sortedExpenses.length - 1) {
                    const pageNum = Math.floor(idx / rowsPerPage) + 1;
                    const totalPages = Math.ceil(sortedExpenses.length / rowsPerPage);

                    const metricsCards = pageNum === 1 ? `
                <div style="display: grid; grid-template-columns: repeat(${Math.min(Object.keys(categoryTotals).length, 4)}, 1fr); gap: 12px; margin-bottom: 14px;">
                    ${Object.keys(categoryTotals).slice(0, 4).map(catKey => `
                        <div style="background: linear-gradient(135deg, ${colors.primary}15 0%, ${colors.primary}08 100%); border: 2px solid ${colors.light}; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.1);">
                            <div style="color: ${colors.primary}; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-${categories[catKey].icon}"></i></div>
                            <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">${categories[catKey].name.substring(0, 12)}</div>
                            <div style="color: ${colors.primary}; font-size: 14px; font-weight: 900;">${formatCurrency(categoryTotals[catKey]).replace('R$', '').trim()}</div>
                        </div>
                    `).join('')}
                </div>
            ` : '';

                    pagesHTML += `
                <div class="pdf-page" style="width: 210mm; height: 297mm; background: #f8fafc; color: #111827; font-family: 'Segoe UI', -apple-system, sans-serif; padding: 0; margin-bottom: 20px; display: flex; flex-direction: column;">
                    ${base.getHeader()}
                    <div style="padding: 14px 24px; flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;">
                        ${metricsCards}
                        <div style="border-bottom: 3px solid ${colors.primary}; padding-bottom: 6px;">
                            <div style="font-size: 13px; font-weight: 900; color: #0f172a; display: flex; align-items: center; gap: 8px;"><i class="fas fa-list-check"></i> ${pageNum > 1 ? 'PARTE ' + pageNum + ' - ' : ''}DESPESAS</div>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, ${colors.primary} 0%, ${colors.dark} 100%); color: white; height: 28px;">
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Categoria</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Data</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Observação</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px;">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentPage.map((e, idx) => `
                                    <tr style="border-bottom: 2px solid ${idx === currentPage.length - 1 ? colors.primary : '#e5e7eb'}; background: ${idx % 2 === 0 ? '#ffffff' : colors.bg}; height: 24px;">
                                        <td style="padding: 6px 8px; font-weight: 700; color: ${colors.primary}; text-align: center; border-right: 1px solid #e5e7eb; font-size: 10px;">${categories[e.category].name.substring(0, 12)}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #475569; font-weight: 600; border-right: 1px solid #e5e7eb; font-size: 10px;">${formatDate(e.date)}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #64748b; font-size: 10px; border-right: 1px solid #e5e7eb; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${e.note ? e.note.substring(0, 18) : '-'}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-weight: 900; color: ${colors.primary}; background: ${idx % 2 === 0 ? '#fef3c7' : '#fde68a'}; font-size: 10px;">${formatCurrency(e.amount).replace('R$', '').trim()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${base.getFooter(pageNum, totalPages, `Total: ${formatCurrency(totalDespesas)}`)}
                </div>
            `;
                    currentPage = [];
                }
            });

            return pagesHTML;
        }

        function generateClientesPageHTML() {
            const clientRentals = {};
            rentals.forEach(r => {
                clientRentals[r.clientName] = (clientRentals[r.clientName] || 0) + r.total;
            });

            const colors = PDF_COLORS.clientes;
            const base = getPDFPageBase('clientes', 'CLIENTES', 'Carteira Ativa', 'address-book');

            if (clients.length === 0) {
                return base.getEmptyState();
            }

            let pagesHTML = '';
            let currentPage = [];
            const rowsPerPage = 25;

            clients.forEach((client, idx) => {
                currentPage.push(client);
                if (currentPage.length === rowsPerPage || idx === clients.length - 1) {
                    const pageNum = Math.floor(idx / rowsPerPage) + 1;
                    const totalPages = Math.ceil(clients.length / rowsPerPage);

                    pagesHTML += `
                <div class="pdf-page" style="width: 210mm; height: 297mm; background: #f8fafc; color: #111827; font-family: 'Segoe UI', -apple-system, sans-serif; padding: 0; margin-bottom: 20px; display: flex; flex-direction: column;">
                    ${base.getHeader()}
                    <div style="padding: 14px 24px; flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;">
                        ${pageNum === 1 ? `
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 14px;">
                                <div style="background: linear-gradient(135deg, ${colors.primary}15 0%, ${colors.primary}08 100%); border: 2px solid ${colors.light}; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);">
                                    <div style="color: ${colors.primary}; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-users"></i></div>
                                    <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">Total Clientes</div>
                                    <div style="color: ${colors.primary}; font-size: 14px; font-weight: 900;">${clients.length}</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #f59e0b15 0%, #f59e0b08 100%); border: 2px solid #fef08a; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(245, 158, 11, 0.1);">
                                    <div style="color: #f59e0b; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-home"></i></div>
                                    <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">Locações</div>
                                    <div style="color: #f59e0b; font-size: 14px; font-weight: 900;">${rentals.length}</div>
                                </div>
                                <div style="background: linear-gradient(135deg, #a855f715 0%, #a855f708 100%); border: 2px solid #e9d5ff; border-radius: 8px; padding: 12px; text-align: center; box-shadow: 0 2px 6px rgba(168, 85, 247, 0.1);">
                                    <div style="color: #a855f7; font-size: 22px; margin-bottom: 4px;"><i class="fas fa-money-bill-wave"></i></div>
                                    <div style="color: #64748b; font-size: 9px; font-weight: 700; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 0.3px;">Receita Total</div>
                                    <div style="color: #a855f7; font-size: 14px; font-weight: 900;">${formatCurrency(calculateTotalRevenue()).replace('R$', '').trim()}</div>
                                </div>
                            </div>
                        ` : ''}
                        <div style="border-bottom: 3px solid ${colors.primary}; padding-bottom: 6px;">
                            <div style="font-size: 13px; font-weight: 900; color: #0f172a; display: flex; align-items: center; gap: 8px;"><i class="fas fa-list-check"></i> ${pageNum > 1 ? 'PARTE ' + pageNum + ' - ' : ''}CLIENTES</div>
                        </div>
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <thead>
                                <tr style="background: linear-gradient(135deg, ${colors.primary} 0%, ${colors.dark} 100%); color: white; height: 28px;">
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Nome</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Email</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">CPF</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px; border-right: 1px solid rgba(255,255,255,0.2);">Tel.</th>
                                    <th style="padding: 7px 8px; text-align: center; font-weight: 800; text-transform: uppercase; font-size: 9px; letter-spacing: 0.5px;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentPage.map((c, idx) => `
                                    <tr style="border-bottom: 2px solid ${idx === currentPage.length - 1 ? colors.primary : '#e5e7eb'}; background: ${idx % 2 === 0 ? '#ffffff' : colors.bg}; height: 24px;">
                                        <td style="padding: 6px 8px; font-weight: 700; color: ${colors.primary}; text-align: center; border-right: 1px solid #e5e7eb; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 10px;">${c.name.substring(0, 15)}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #475569; border-right: 1px solid #e5e7eb; font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${c.email ? c.email.substring(0, 14) : '-'}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #475569; font-size: 10px; border-right: 1px solid #e5e7eb;">${c.cpf ? c.cpf.substring(0, 5) + '...' : '-'}</td>
                                        <td style="padding: 6px 8px; text-align: center; color: #475569; font-size: 10px; border-right: 1px solid #e5e7eb;">${c.phone ? c.phone.substring(0, 10) : '-'}</td>
                                        <td style="padding: 6px 8px; text-align: center; font-weight: 900; color: ${colors.primary}; background: ${idx % 2 === 0 ? colors.bg : '#e0e7ff'}; font-size: 10px;">${formatCurrency(clientRentals[c.name] || 0).replace('R$', '').trim()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${base.getFooter(pageNum, totalPages)}
                </div>
            `;
                    currentPage = [];
                }
            });

            return pagesHTML;
        }

        // ===== FORM HANDLERS =====
        function setupFormHandlers() {
            document.getElementById('rentalForm').addEventListener('submit', submitRental);
            document.getElementById('editRentalForm').addEventListener('submit', submitEditRental);
            document.getElementById('editExpenseForm').addEventListener('submit', submitEditExpense);
            document.getElementById('settingsForm').addEventListener('submit', submitSettings);
            document.getElementById('clientForm').addEventListener('submit', submitClient);
            document.getElementById('editClientForm').addEventListener('submit', submitEditClient);
            document.getElementById('reserveForm').addEventListener('submit', submitReserve);
            document.getElementById('editReserveForm').addEventListener('submit', submitEditReserve);
            document.getElementById('addNoteForm').addEventListener('submit', submitAddNote);
        }

        function submitRental(e) {
            e.preventDefault();

            if (selectedDays.length === 0) {
                showToast('Selecione pelo menos um dia', 'warning', 2000);
                return;
            }

            const clientName = document.getElementById('clientName').value;
            const dailyRate = parseFloat(document.getElementById('dailyRate').value);

            if (!clientName || !dailyRate) {
                showToast('Preencha todos os campos obrigatórios', 'warning', 2000);
                return;
            }

            const rental = {
                id: Date.now().toString(),
                clientName,
                startDate: selectedDays[0],
                endDate: selectedDays[selectedDays.length - 1],
                days: selectedDays.length,
                dailyRate,
                total: dailyRate * selectedDays.length,
                createdAt: new Date().toISOString()
            };

            rentals.push(rental);
            saveToFirebase('rentals', rentals);
            document.getElementById('rentalForm').reset();
            selectedDays = [];
            closeModal('rentalModal');
            showToast(`Locação de ${rental.days} dias registrada com sucesso!`, 'success', 2000);
            renderPage();
        }

        function submitEditRental(e) {
            e.preventDefault();

            const rental = rentals.find(r => r.id === currentEditingRentalId);
            if (!rental) {
                showToast('Erro ao atualizar locação', 'error', 2000);
                return;
            }

            const clientName = document.getElementById('editRentalClientName').value;
            const startDate = document.getElementById('editRentalStartDate').value;
            const endDate = document.getElementById('editRentalEndDate').value;
            const dailyRate = parseFloat(document.getElementById('editRentalDailyRate').value);

            if (!clientName || !startDate || !endDate || !dailyRate) {
                showToast('Preencha todos os campos obrigatórios', 'warning', 2000);
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('Data inicial deve ser anterior à data final', 'warning', 2000);
                return;
            }

            rental.clientName = clientName;
            rental.startDate = startDate;
            rental.endDate = endDate;
            rental.dailyRate = dailyRate;

            const start = new Date(startDate);
            const end = new Date(endDate);
            rental.days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            rental.total = rental.dailyRate * rental.days;

            saveToFirebase('rentals', rentals);
            closeModal('editRentalModal');
            showToast('Locação atualizada com sucesso!', 'success', 2000);
            renderPage();
        }

        function submitEditExpense(e) {
            e.preventDefault();

            const exp = expenses.find(e => e.id === currentEditingExpenseId);
            if (!exp) {
                showToast('Erro ao atualizar lançamento', 'error', 2000);
                return;
            }

            const amount = parseFloat(document.getElementById('editAmount').value);
            const date = document.getElementById('editDate').value;

            if (!amount || amount <= 0) {
                showToast('Digite um valor válido e maior que zero', 'warning', 2000);
                return;
            }

            if (!date) {
                showToast('Selecione uma data', 'warning', 2000);
                return;
            }

            exp.amount = amount;
            exp.date = date;
            exp.note = document.getElementById('editNote').value;
            saveToFirebase('expenses', expenses);
            closeModal('editExpenseModal');
            showToast('Lançamento atualizado com sucesso!', 'success', 2000);
            renderPage();
        }

        function submitSettings(e) {
            e.preventDefault();

            const initialCapital = parseFloat(document.getElementById('initialCapital').value);
            const defaultDailyRate = parseFloat(document.getElementById('defaultDailyRate').value);

            if (!initialCapital || initialCapital <= 0 || !defaultDailyRate || defaultDailyRate <= 0) {
                showToast('Digite valores válidos e maiores que zero', 'warning', 2000);
                return;
            }

            settings.initialCapital = initialCapital;
            settings.defaultDailyRate = defaultDailyRate;

            saveToFirebase('settings', settings);
            closeModal('settingsModal');
            showToast('Configurações salvas com sucesso!', 'success', 2000);
            renderPage();
        }

        function submitClient(e) {
            e.preventDefault();

            const name = document.getElementById('clientFullName').value;
            const email = document.getElementById('clientEmail').value;
            const cpf = document.getElementById('clientCPF').value;
            const phone = document.getElementById('clientPhone').value;

            if (!name) {
                showToast('Digite o nome do cliente', 'warning', 2000);
                return;
            }

            const client = {
                id: Date.now().toString(),
                name,
                email,
                cpf,
                phone,
                createdAt: new Date().toISOString()
            };

            clients.push(client);
            saveToFirebase('clients', clients);
            document.getElementById('clientForm').reset();
            closeModal('clientModal');
            showToast(`Cliente "${name}" adicionado com sucesso!`, 'success', 2000);
            renderPage();
        }

        function submitEditClient(e) {
            e.preventDefault();

            const client = clients.find(c => c.id === currentEditingClientId);
            if (!client) {
                showToast('Erro ao atualizar cliente', 'error', 2000);
                return;
            }

            const name = document.getElementById('editClientName').value;
            if (!name) {
                showToast('Digite o nome do cliente', 'warning', 2000);
                return;
            }

            client.name = name;
            client.email = document.getElementById('editClientEmail').value;
            client.cpf = document.getElementById('editClientCPF').value;
            client.phone = document.getElementById('editClientPhone').value;
            saveToFirebase('clients', clients);
            closeModal('editClientModal');
            showToast(`Cliente "${name}" atualizado com sucesso!`, 'success', 2000);
            renderPage();
        }

        function submitReserve(e) {
            e.preventDefault();

            if (selectedDays.length === 0) {
                showToast('Selecione um período', 'warning', 2000);
                return;
            }

            const clientId = document.getElementById('reserveClient').value;
            const rate = parseFloat(document.getElementById('reserveRate').value);

            if (!clientId || !rate || rate <= 0) {
                showToast('Preencha todos os campos obrigatórios', 'warning', 2000);
                return;
            }

            const client = clients.find(c => c.id === clientId);
            if (!client) {
                showToast('Cliente não encontrado', 'error', 2000);
                return;
            }

            const reserve = {
                id: Date.now().toString(),
                clientName: client.name,
                clientId,
                startDate: selectedDays[0],
                endDate: selectedDays[selectedDays.length - 1],
                days: selectedDays.length,
                dailyRate: rate,
                createdAt: new Date().toISOString()
            };

            reserves.push(reserve);
            saveToFirebase('reserves', reserves);
            document.getElementById('reserveForm').reset();
            selectedDays = [];
            closeModal('reserveModal');
            showToast(`Reserva de ${reserve.days} dias criada com sucesso!`, 'success', 2000);
            renderPage();
        }

        function submitEditReserve(e) {
            e.preventDefault();

            const reserve = reserves.find(r => r.id === currentEditingReserveId);
            if (!reserve) {
                showToast('Erro ao atualizar reserva', 'error', 2000);
                return;
            }

            const startDate = document.getElementById('editReserveStartDate').value;
            const endDate = document.getElementById('editReserveEndDate').value;
            const dailyRate = parseFloat(document.getElementById('editReserveDailyRate').value);

            if (!startDate || !endDate || !dailyRate || dailyRate <= 0) {
                showToast('Preencha todos os campos obrigatórios', 'warning', 2000);
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showToast('Data inicial deve ser anterior à data final', 'warning', 2000);
                return;
            }

            reserve.startDate = startDate;
            reserve.endDate = endDate;
            reserve.dailyRate = dailyRate;

            const start = new Date(startDate);
            const end = new Date(endDate);
            reserve.days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            saveToFirebase('reserves', reserves);
            closeModal('editReserveModal');
            showToast('Reserva atualizada com sucesso!', 'success', 2000);
            renderPage();
        }

        function submitAddNote(e) {
            e.preventDefault();

            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;

            if (!title || !content) {
                showToast('Preencha título e conteúdo', 'warning', 2000);
                return;
            }

            const note = {
                id: Date.now().toString(),
                title,
                content,
                createdAt: new Date().toISOString()
            };

            notes.push(note);
            saveToFirebase('notes', notes);
            document.getElementById('addNoteForm').reset();
            closeModal('addNoteModal');
            showToast('Anotação salva com sucesso!', 'success', 2000);
            renderPage();
        }

        function calcRentalTotal() {
            const dailyRate = parseFloat(document.getElementById('dailyRate').value) || 0;
            const total = dailyRate * selectedDays.length;
            document.getElementById('rentalTotal').value = total > 0 ? formatCurrency(total) : '';
            document.getElementById('daysCount').value = selectedDays.length;
            document.getElementById('periodSelected').value = selectedDays.length > 0
                ? `${formatDate(selectedDays[0])} a ${formatDate(selectedDays[selectedDays.length - 1])}`
                : '';
        }

        function calcEditReserveTotal() {
            const startDate = new Date(document.getElementById('editReserveStartDate').value);
            const endDate = new Date(document.getElementById('editReserveEndDate').value);
            const dailyRate = parseFloat(document.getElementById('editReserveDailyRate').value) || 0;

            if (startDate && endDate && startDate <= endDate) {
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('editReserveTotal').value = formatCurrency(dailyRate * days);
            }
        }
        // ===== CALCULATIONS =====
        function calculateCapital() {
            let capital = settings.initialCapital;
            rentals.forEach(r => capital += r.total);
            expenses.forEach(e => capital -= e.amount);
            return capital;
        }

        function calculateMonthlyRevenue() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return rentals
                .filter(r => r.startDate.startsWith(currentMonth))
                .reduce((sum, r) => sum + r.total, 0);
        }

        function calculateMonthlyExpenses() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return expenses
                .filter(e => e.date.startsWith(currentMonth))
                .reduce((sum, e) => sum + e.amount, 0);
        }

        function calculateRentedDays() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return rentals
                .filter(r => r.startDate.startsWith(currentMonth))
                .reduce((sum, r) => sum + r.days, 0);
        }

        function calculateTotalRevenue() {
            return rentals.reduce((sum, r) => sum + r.total, 0);
        }

        function calculateTotalExpenses() {
            return expenses.reduce((sum, e) => sum + e.amount, 0);
        }

        function getNextRental() {
            const sorted = rentals.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
            return sorted.find(r => new Date(r.endDate) >= new Date());
        }

        // ===== TOAST NOTIFICATIONS =====
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        font-size: 14px;
        font-weight: 500;
        max-width: 90%;
    `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ===== CONFIRM MODAL =====
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;

            const confirmBtn = document.getElementById('confirmButton');
            confirmBtn.onclick = () => {
                closeModal('confirmModal');
                onConfirm();
            };

            openModal('confirmModal');
        }

        // ===== RESET DATA =====
        function resetAllData() {
            closeModal('settingsModal');

            setTimeout(() => {
                showConfirmModal(
                    'Resetar Todos os Dados',
                    'Deseja resetar TODOS os dados? Locações, despesas, reservas, clientes e anotações serão removidos. Esta ação não pode ser desfeita!',
                    () => {
                        rentals = [];
                        expenses = [];
                        reserves = [];
                        clients = [];
                        notes = [];
                        settings = {
                            initialCapital: 5000,
                            defaultDailyRate: 200
                        };
                        saveToFirebase('rentals', rentals);
                        saveToFirebase('expenses', expenses);
                        saveToFirebase('reserves', reserves);
                        saveToFirebase('clients', clients);
                        saveToFirebase('notes', notes);
                        saveToFirebase('settings', settings);
                        showToast('Todos os dados foram resetados com sucesso!', 'success', 2000);
                        renderPage();
                    }
                );
            }, 300);
        }

        // ===== START =====
        initAuth();
    </script>
</body>

</html>
